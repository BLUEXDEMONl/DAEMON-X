<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Sophia Tech</title>
    <style>
        :root {
            --primary: #2563EB; 
            --primary-dark: #1D4ED8; 
            --accent: #D97706; 
            --accent-hover: #F59E0B; 

            --bg-primary: #111827; 
            --bg-secondary: #1F2937; 
            --bg-tertiary: #2d3748; 

            --text-primary: #E5E7EB; 
            --text-secondary: #9CA3AF; 
            --text-muted: #6B7280;
            
            --border-primary: #374151; 
            --border-secondary: #4B5563;

            --success: #10B981; 
            --error: #DC2626; 
            --warning: #F59E0B;

            --primary-rgb: 37, 99, 235; 
            --accent-rgb: 217, 119, 6; 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: var(--bg-primary); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
            padding-top: 70px; 
            padding-bottom: 70px; 
            line-height: 1.6;
        }
        
        .dashboard-header {
          width: 100%;
          background-color: var(--bg-secondary); 
          padding: 15px 30px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
          border-bottom: 1px solid var(--border-primary);
          position: fixed; 
          top: 0;
          left: 0;
          z-index: 1000;
        }

        .dashboard-header .logo {
          font-size: 1.5em;
          font-weight: bold;
          color: var(--primary); 
          display: flex;
          align-items: center;
        }
        .dashboard-header .logo svg {
            width: 30px;
            height: 30px;
            fill: var(--primary); 
            vertical-align: middle;
            margin-right: 8px;
        }


        .main-content {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            padding: 40px 20px;
        }
        
         @keyframes fadeInScaleUp {
             from {
                 opacity: 0;
                 transform: scale(0.95) translateY(20px);
             }
             to {
                 opacity: 1;
                 transform: translateY(0);
             }
         }


        .profile-container {
            background-color: var(--bg-secondary);
            padding: 30px 35px 40px 35px; 
            border-radius: 12px;
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4); 
            width: 100%;
            max-width: 650px; 
            border: 1px solid var(--border-primary);
            text-align: center; 
        }

         .profile-header {
             margin-bottom: 30px; 
             display: flex;
             flex-direction: column;
             align-items: center;
             animation: slideDownInner 0.6s ease-out 0.5s forwards;
             opacity: 0;
             transform: translateY(-15px);
             position: relative; 
             border-bottom: 1px solid var(--border-primary);
             padding-bottom: 25px;
         }

         .avatar-container {
             width: 130px; 
             height: 130px;
             border-radius: 50%;
             background-color: var(--bg-tertiary);
             display: flex;
             justify-content: center;
             align-items: center;
             margin-bottom: 15px; 
             border: 4px solid var(--border-primary); 
             box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); 
             overflow: hidden;
             position: relative; 
             cursor: pointer; 
             transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
         .avatar-container:hover {
             transform: scale(1.05);
             box-shadow: 0 10px 25px rgba(var(--accent-rgb), 0.2); 
         }

         #avatar-image {
             width: 100%;
             height: 100%;
             object-fit: cover; 
             display: block; 
         }

         .avatar-container svg#avatar-placeholder-svg { 
             width: 60%;
             height: 60%;
             fill: var(--text-secondary);
             opacity: 0.7;
             transition: opacity 0.3s ease;
         }

         #avatar-upload-input {
             display: none;
         }

         .avatar-upload-overlay {
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: rgba(45, 55, 72, 0.7); 
             display: flex;
             flex-direction: column; 
             justify-content: center;
             align-items: center;
             opacity: 0;
             transition: opacity 0.3s ease;
             pointer-events: none; 
             border-radius: 50%;
         }


         .avatar-container:hover .avatar-upload-overlay {
             opacity: 1;
             pointer-events: auto; 
         }

         .avatar-upload-overlay span {
             color: var(--text-primary);
             font-size: 0.9em; 
             font-weight: bold;
             text-align: center;
             padding: 0 5px; 
        }
         .avatar-upload-overlay svg { 
            width: 35px; 
            height: 35px;
            fill: var(--text-primary);
            margin-bottom: 8px; 
         }

        .username-line {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }

         #profile-username-header {
             font-size: 1.8em; 
             font-weight: bold;
             color: var(--text-primary);
             word-break: break-word; 
         }
         #verification-badge-container {
             margin-left: 8px;
             display: inline-flex; /* Aligns SVG nicely */
             align-items: center;
         }
         #verification-badge-container svg {
            width: 22px; /* Adjust size as needed */
            height: 22px;
            fill: var(--success); /* Optional: if you want to color it with CSS */
         }

         #profile-header-email { 
            font-size: 0.95em;
            color: var(--text-secondary);
            word-break: break-all;
         }

        .page-title { 
             font-size: 2em;
             margin-bottom: 10px;
             color: var(--text-primary);
             font-weight: 600;
        }
        
        .profile-section-title {
            font-size: 1.3em;
            color: var(--text-primary);
            font-weight: bold;
            text-align: left;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-primary);
             animation: slideUpInner 0.6s ease-out 0.6s forwards;
             opacity: 0;
             transform: translateY(15px);
        }

        .profile-details {
             animation: slideUpInner 0.6s ease-out 0.7s forwards;
             opacity: 0;
             transform: translateY(15px);
             text-align: left; 
             margin-bottom: 30px; 
        }

        .profile-item {
            margin-bottom: 12px; 
            border-bottom: 1px solid var(--border-primary); 
            padding: 12px 8px; 
            display: flex;
            align-items: center;
             flex-wrap: wrap;
             gap: 8px 15px; 
             border-radius: 6px;
             transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .profile-item:hover {
            background-color: var(--bg-tertiary);
            transform: translateX(5px);
        }
        .profile-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .profile-item label {
            font-weight: bold;
            color: var(--text-secondary);
            width: 130px; 
            flex-shrink: 0;
            font-size: 0.9em; 
        }

        .profile-item span, .profile-item a {
            font-size: 1em; 
            color: var(--text-primary);
            word-break: break-all;
             flex-grow: 1;
             min-width: 150px;
        }
        
        #profile-role { 
            text-transform: capitalize;
        }


        #message {
             margin-bottom: 25px; 
             text-align: center;
             font-weight: bold;
             min-height: 1.2em;
             font-size: 0.95em;
             transition: opacity 0.3s ease, color 0.3s ease;
             padding: 10px;
             border-radius: 6px;
             display: none; 
         }
         #message.success {
             color: var(--success);
             background-color: rgba(16, 185, 129, 0.1);
             border: 1px solid rgba(16, 185, 129, 0.3);
             display: block;
         }
         #message.error { 
             color: var(--error);
             background-color: rgba(220, 38, 38, 0.1);
             border: 1px solid rgba(220, 38, 38, 0.3);
             display: block;
         }
        .profile-actions-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
            align-items: center; /* Center buttons */
            animation: slideUpInner 0.6s ease-out 0.8s forwards;
            opacity: 0;
            transform: translateY(15px);
        }

        .profile-action-button {
            padding: 12px 25px; 
            border: none;
            border-radius: 8px;
            font-size: 1em;
            color: var(--text-primary); 
            cursor: pointer;
            transition: background 0.3s ease, transform 0.15s ease, box-shadow 0.2s ease;
            font-weight: bold;
            letter-spacing: 0.5px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            width: 100%;
            max-width: 280px; /* Max width for buttons */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
         .profile-action-button svg {
            width: 18px; height: 18px; fill: currentColor;
         }

        #copy-profile-link-button {
            background: var(--primary);
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3);
        }
        #copy-profile-link-button:hover {
             background: var(--primary-dark);
             box-shadow: 0 8px 20px rgba(var(--primary-rgb), 0.35);
             transform: translateY(-2px) scale(1.03);
        }

        #chat-with-user-button {
            background: var(--accent);
            box-shadow: 0 4px 12px rgba(var(--accent-rgb), 0.3);
            display: none; /* Hidden by default, shown for other user profiles */
        }
         #chat-with-user-button:hover {
             background: var(--accent-hover);
             box-shadow: 0 8px 20px rgba(var(--accent-rgb), 0.35);
             transform: translateY(-2px) scale(1.03);
         }


        #logout-button {
            background: var(--error); 
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); 
        }
         #logout-button:hover {
             background: #E53935; 
             box-shadow: 0 8px 20px rgba(220, 38, 38, 0.35);
             transform: translateY(-2px) scale(1.03);
         }
         #logout-button:active { /* Common active style for all profile action buttons */
             transform: translateY(0px) scale(0.97);
         }


        @keyframes slideDownInner {
             from {
                 opacity: 0;
                 transform: translateY(-15px);
             }
             to {
                 opacity: 1;
                 transform: translateY(0);
             }
         }

         @keyframes slideUpInner {
             from {
                 opacity: 0;
                 transform: translateY(15px);
             }
             to {
                 opacity: 1;
                 transform: translateY(0);
             }
         }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-secondary); 
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            z-index: 1000;
            animation: slideUpNav 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(100%);
       }

         @keyframes slideUpNav {
            from {
                opacity: 0;
                transform: translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary); 
           transition: color 0.3s ease, transform 0.2s ease;
            border: none;
            background: none;
            cursor: pointer;
            padding: 5px 10px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            flex: 1;
            text-align: center;
       }

        .nav-item svg {
            width: 24px; 
            height: 24px;
            fill: currentColor;
            margin-bottom: 3px;
            transition: transform 0.2s ease;
       }

        .nav-item:hover {
           color: var(--accent-hover); 
           transform: translateY(-2px);
       }
         .nav-item:hover svg {
             transform: scale(1.1);
         }

        .nav-item.active {
           color: var(--accent); 
           font-weight: bold;
        }
        .nav-item.active svg {
           filter: drop-shadow(0 0 3px var(--accent));
        }

        .nav-item span {
            font-size: 0.75em;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        .spinner, #page-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: var(--text-secondary);
        }
        #page-loader {
             height: calc(100vh - 140px); /* Full viewport height minus header and footer */
        }
        .spinner { /* For specific loading states like avatar upload */
            border: 3px solid rgba(229, 231, 235, 0.3); 
            border-radius: 50%;
            border-top: 3px solid var(--primary); 
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto; 
        }


        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    </style>
</head>
<body>

    <header class="dashboard-header"> 
      <div class="logo">
          <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4Z" /><path d="M12 6C13.6569 6 15 7.34315 15 9C15 10.6569 13.6569 12 12 12C10.3431 12 9 10.6569 9 9C9 7.34315 10.3431 6 12 6Z" /><path d="M6 12C6 13.6569 7.34315 15 9 15C10.6569 15 12 13.6569 12 12H10C10 12.5523 9.55228 13 9 13C8.44772 13 8 12.5523 8 12H6Z" /><path d="M18 12C18 13.6569 16.6569 15 15 15C13.3431 15 12 13.6569 12 12H14C14 12.5523 14.4477 13 15 13C15.5523 13 16 12.5523 16 12H18Z" /><path d="M12 18C13.6569 18 15 16.6569 15 15H13C13 15.5523 12.5523 16 12 16C11.4477 16 11 15.5523 11 15H9C9 16.6569 10.3431 18 12 18Z" /></svg>
          Sophia Tech
      </div>
    </header>

    <div id="page-loader">
      <p>Loading Profile...</p>
    </div>

    <main class="main-content" style="display: none;">
        <div class="profile-container">
             <h1 class="page-title" style="display: block;">User Profile</h1> 
             <div id="message"></div>
            
             <div class="profile-header" style="display: none;">
                 <div class="avatar-container" id="avatar-clickable-area">
                      <img id="avatar-image" src="" alt="User Avatar" style="display: none;">
                      <svg id="avatar-placeholder-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                      <div class="avatar-upload-overlay">
                          <label for="avatar-upload-input" style="cursor: pointer; display: flex; flex-direction: column; align-items: center;">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M19.35 10.04A7.49 7.49 0 0012 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 000 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"></path></svg>
                              <span>Upload Photo</span>
                          </label>
                      </div>
                 </div>
                 <input type="file" id="avatar-upload-input" accept="image/*"> 
                 <div class="username-line">
                    <span id="profile-username-header">[Username]</span>
                    <span id="verification-badge-container"></span>
                 </div>
                 <span id="profile-header-email"></span>
             </div>
            
            <h2 class="profile-section-title" style="display: none;">Account Information</h2>
            <div class="profile-details" style="display: none;">
                <div class="profile-item">
                    <label>User ID:</label>
                    <span id="profile-id"></span>
                </div>
                <div class="profile-item">
                    <label>Username:</label>
                    <span id="profile-username-detail"></span>
                </div>
                <div class="profile-item">
                    <label>Email:</label>
                    <span id="profile-email-detail"></span>
                </div>
                <div class="profile-item">
                    <label>Role:</label>
                    <span id="profile-role"></span>
                </div>
            </div>

            <div class="profile-actions-container" style="display: none;">
                <button id="copy-profile-link-button" class="profile-action-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
                    Copy Profile Link
                </button>
                <button id="chat-with-user-button" class="profile-action-button" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg>
                    Chat with User
                </button>
                <button id="logout-button" class="profile-action-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"></path></svg>
                    Logout
                </button>
            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="/dashboard" class="nav-item">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 4h6v6H4zm0 10h6v6H4zm10-10h6v6h-6zm0 10h6v6h-6z"></path></svg>
             <span>Dashboard</span>
        </a>
        <a href="/panel" class="nav-item" id="admin-panel-link" style="display: none;">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                 <path d="M12.74 2.32a1 1 0 0 0-1.48 0l-9 9A1 1 0 0 0 3 13h1v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7h1a1 1 0 0 0 .74-1.68l-9-9zM12 4.5l5 5V12h-2v-1a1 1 0 0 0-2 0v1H9V10c0-.47-.14-.93-.4-1.32L5 5.8V5h7zm-1 11v-1h2v1h-2zM5 19v-5h14v5H5z"/>
                 <path d="M15.71 14.29a1 1 0 0 0-1.42 1.42L16 17.42V20h-2v-2.58l-1.71-1.71a1 1 0 0 0-1.42 0 1 1 0 0 0 0 1.42L12.58 19H11a1 1 0 0 0-.71.29 1 1 0 0 0-.21.33 1 1 0 0 0 .21 1.07 1 1 0 0 0 .71.29h3a1 1 0 0 0 .71-.29 1 1 0 0 0 .21-1.07 1 1 0 0 0-.21-.33A1 1 0 0 0 13 19h-.58l1.71-1.71a1 1 0 0 0 .03-.02 1 1 0 0 0-.03-1.42z"/>
             </svg>
            <span>Panel</span>
        </a>
        <a href="/inbox" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/></svg>
            <span>Inbox</span>
        </a>
        <a href="/profile" class="nav-item active">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
            <span>Profile</span>
        </a>
    </nav>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const mainContentElement = document.querySelector('.main-content');
    const pageLoaderElement = document.getElementById('page-loader');
    const adminPanelLink = document.getElementById('admin-panel-link');
    
    if(mainContentElement) mainContentElement.style.display = 'none';
    if(pageLoaderElement) pageLoaderElement.style.display = 'flex';

    const loggedInUserString = localStorage.getItem('loggedInUser');

    if (!loggedInUserString) {
        window.location.href = '/login';
        return;
    }

    let userFromStorage;
    try {
        userFromStorage = JSON.parse(loggedInUserString);
        if (!userFromStorage || !userFromStorage.id) {
            throw new Error("Invalid user data in localStorage");
        }
    } catch (error) {
        console.error('Error parsing user data from localStorage:', error);
        localStorage.removeItem('loggedInUser');
        window.location.href = '/login';
        return;
    }

    if (userFromStorage.role === 'admin' && adminPanelLink) {
        adminPanelLink.style.display = 'flex';
    }

    fetch(`/auth/verify-user/${userFromStorage.id}`)
        .then(response => {
            if (!response.ok) {
                localStorage.removeItem('loggedInUser');
                window.location.href = '/login';
                throw new Error(`User verification failed: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.isValid) {
                if(data.user) {
                    localStorage.setItem('loggedInUser', JSON.stringify(data.user)); 
                    initializeProfilePage(data.user);
                } else {
                    initializeProfilePage(userFromStorage); 
                }
                
                if(mainContentElement) {
                    mainContentElement.style.display = 'flex';
                    mainContentElement.style.animation = 'fadeInScaleUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
                }
                if(pageLoaderElement) pageLoaderElement.style.display = 'none';
            } else {
                localStorage.removeItem('loggedInUser');
                window.location.href = '/login';
            }
        })
        .catch(error => {
            console.error('Error during user verification process:', error);
            localStorage.removeItem('loggedInUser');
            window.location.href = '/login';
        });
});

function initializeProfilePage(currentUser) {
    const messageDiv = document.getElementById('message');
    
    const profileHeaderDiv = document.querySelector('.profile-header');
    const profileSectionTitle = document.querySelector('.profile-section-title');
    const profileDetailsDiv = document.querySelector('.profile-details');
    const profileActionsContainer = document.querySelector('.profile-actions-container');
    const pageTitleH1 = document.querySelector('.page-title'); 

    const avatarImage = document.getElementById('avatar-image');
    const avatarPlaceholder = document.getElementById('avatar-placeholder-svg');
    const avatarClickableArea = document.getElementById('avatar-clickable-area');
    const avatarUploadInput = document.getElementById('avatar-upload-input');
    const verificationBadgeContainer = document.getElementById('verification-badge-container');

    const copyProfileLinkButton = document.getElementById('copy-profile-link-button');
    const chatWithUserButton = document.getElementById('chat-with-user-button'); 

    function showUserMessage(text, type = 'neutral', duration = 3000) {
        if (messageDiv) {
            messageDiv.textContent = text;
            messageDiv.className = ''; 
            if (type === 'success') {
                messageDiv.classList.add('success');
            } else if (type === 'error') {
                messageDiv.classList.add('error');
            }
            messageDiv.style.display = 'block';

            if (duration > 0) { 
                setTimeout(() => {
                    if (messageDiv.textContent === text) { 
                        messageDiv.style.display = 'none';
                        messageDiv.textContent = '';
                        messageDiv.className = '';
                    }
                }, duration);
            }
        }
    }

    const profileUsernameHeader = document.getElementById('profile-username-header');
    const profileHeaderEmail = document.getElementById('profile-header-email');
    const profileIdSpan = document.getElementById('profile-id');
    const profileUsernameDetail = document.getElementById('profile-username-detail');
    const profileEmailDetail = document.getElementById('profile-email-detail');
    const profileRoleSpan = document.getElementById('profile-role');

    if (profileUsernameHeader) profileUsernameHeader.textContent = currentUser.username || 'N/A';
    if (profileHeaderEmail) profileHeaderEmail.textContent = currentUser.email || 'N/A';
    if (profileIdSpan) profileIdSpan.textContent = currentUser.profileSlug || currentUser.id.substring(0,8)+'...';
    if (profileUsernameDetail) profileUsernameDetail.textContent = currentUser.username || 'N/A';
    if (profileEmailDetail) profileEmailDetail.textContent = currentUser.email || 'N/A';
    if (profileRoleSpan) {
      profileRoleSpan.textContent = currentUser.role ? currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1) : 'N/A';
    }
    
    if (pageTitleH1 && profileUsernameHeader && profileUsernameHeader.textContent !== '[Username]') {
        pageTitleH1.style.display = 'none'; 
    }
    
    if (profileHeaderDiv) profileHeaderDiv.style.display = 'flex';
    if (profileSectionTitle) profileSectionTitle.style.display = 'block';
    if (profileDetailsDiv) profileDetailsDiv.style.display = 'block';
    if (profileActionsContainer) profileActionsContainer.style.display = 'flex'; 
    
    if (currentUser.avatarUrl && avatarImage) {
        avatarImage.src = currentUser.avatarUrl;
        avatarImage.style.display = 'block';
        if(avatarPlaceholder) avatarPlaceholder.style.display = 'none';
    } else {
        if(avatarImage) avatarImage.style.display = 'none';
        if(avatarPlaceholder) avatarPlaceholder.style.display = 'block';
    }

    if (verificationBadgeContainer) {
        if (currentUser.verified) {
            verificationBadgeContainer.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.9388 1.13669C11.4793 0.449229 12.5208 0.44923 13.0613 1.13669L14.808 3.35829L17.527 2.58767C18.3683 2.34921 19.2109 2.96138 19.2441 3.83525L19.3514 6.65926L22.004 7.63397C22.8249 7.93559 23.1467 8.92611 22.6599 9.6526L21.0868 12.0003L22.6599 14.3481C23.1467 15.0746 22.8249 16.0651 22.004 16.3667L19.3514 17.3414L19.2441 20.1654C19.2109 21.0393 18.3683 21.6515 17.527 21.413L14.808 20.6424L13.0613 22.864C12.5208 23.5515 11.4793 23.5515 10.9388 22.864L9.19206 20.6424L6.47311 21.413C5.63175 21.6515 4.78916 21.0393 4.75596 20.1654L4.64866 17.3414L1.99603 16.3667C1.17519 16.0651 0.853351 15.0746 1.34014 14.3481L2.91324 12.0003L1.34013 9.6526C0.85335 8.92611 1.17519 7.93559 1.99603 7.63397L4.64866 6.65926L4.75596 3.83525C4.78916 2.96138 5.63175 2.34921 6.47311 2.58767L9.19206 3.35829L10.9388 1.13669ZM8.35859 11.8486C8.65148 11.5557 9.12635 11.5557 9.41925 11.8486L10.8889 13.3182L14.3586 9.84858C14.6515 9.55568 15.1264 9.55568 15.4192 9.84858C15.7121 10.1415 15.7121 10.6163 15.4192 10.9092L11.4192 14.9092C11.1264 15.2021 10.6515 15.2021 10.3586 14.9092L8.35859 12.9092C8.06569 12.6163 8.06569 12.1415 8.35859 11.8486Z" clip-rule="evenodd"></path>
                </svg>
            `;
        } else {
            verificationBadgeContainer.innerHTML = ''; 
        }
    }

    if (copyProfileLinkButton) {
        copyProfileLinkButton.style.display = 'flex'; 
        copyProfileLinkButton.addEventListener('click', () => {
            if (!currentUser.profileSlug) {
                 showUserMessage('Profile link not available. Please try re-logging in.', 'error');
                 return;
            }
            const profileUrl = `${window.location.origin}/profile/${currentUser.profileSlug}`;
            navigator.clipboard.writeText(profileUrl)
                .then(() => showUserMessage('Profile link copied to clipboard!', 'success'))
                .catch(err => {
                    console.error('Failed to copy profile link:', err);
                    showUserMessage('Failed to copy link.', 'error');
                });
        });
    }
    if (chatWithUserButton) {
        chatWithUserButton.style.display = 'none'; 
    }


    const logoutButton = document.getElementById('logout-button');
    if (logoutButton) {
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('loggedInUser');
            showUserMessage('Logged out successfully. Redirecting...', 'success', 1000);
            setTimeout(() => {
                window.location.href = '/login';
            }, 1000);
        });
    }

    if(avatarClickableArea && avatarUploadInput) {
        avatarClickableArea.addEventListener('click', () => {
            avatarUploadInput.click();
        });

        avatarUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                showUserMessage('Uploading avatar...', 'neutral', 0); 

                try {
                    const latestUserString = localStorage.getItem('loggedInUser');
                    if (!latestUserString) throw new Error("User session lost during avatar upload.");
                    const latestUser = JSON.parse(latestUserString);


                    const formData = new FormData();
                    formData.append('avatarFile', file); 
                    formData.append('userId', latestUser.id);

                    const response = await fetch('/auth/user/avatar', {
                        method: 'POST',
                        body: formData 
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        showUserMessage('Avatar updated successfully!', 'success');
                        
                        latestUser.avatarUrl = result.avatarUrl; 
                        localStorage.setItem('loggedInUser', JSON.stringify(latestUser)); 
                        
                        if (avatarImage) {
                            avatarImage.src = result.avatarUrl; 
                            avatarImage.style.display = 'block';
                        }
                        if (avatarPlaceholder) {
                            avatarPlaceholder.style.display = 'none';
                        }
                    } else {
                        showUserMessage(result.message || 'Failed to update avatar on server.', 'error');
                        if (latestUser.avatarUrl && avatarImage) avatarImage.src = latestUser.avatarUrl; 
                        else if(avatarImage && avatarPlaceholder) {
                            avatarImage.style.display = 'none';
                            avatarPlaceholder.style.display = 'block';
                        }
                    }

                } catch (error) {
                    console.error('Avatar upload error:', error);
                    showUserMessage('Network error or server issue during avatar upload.', 'error');
                    const fallbackUserString = localStorage.getItem('loggedInUser');
                    if(fallbackUserString) {
                        const fallbackUser = JSON.parse(fallbackUserString);
                        if (fallbackUser.avatarUrl && avatarImage) avatarImage.src = fallbackUser.avatarUrl;
                        else if(avatarImage && avatarPlaceholder) {
                            avatarImage.style.display = 'none';
                            avatarPlaceholder.style.display = 'block';
                        }
                    }
                } finally {
                    avatarUploadInput.value = ''; 
                }
            } else if (file) {
                 showUserMessage('Please select a valid image file (e.g., PNG, JPG).', 'error');
                 avatarUploadInput.value = ''; 
            }
        });
    }

    if (currentUser.role === 'admin') {
        // Admin specific profile logic can go here
    }
}
</script>
</body>
</html>
