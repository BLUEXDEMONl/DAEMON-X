<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Sophia Tech</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563EB; 
      --primary-dark: #1D4ED8; 
      --accent: #D97706; 
      --accent-hover: #F59E0B; 

      --bg-primary: #111827; 
      --bg-secondary: #1F2937; 
      --bg-tertiary: #2d3748; 

      --text-primary: #E5E7EB; 
      --text-secondary: #9CA3AF; 
      --text-muted: #6B7280;
      
      --border-primary: #374151; 
      --border-secondary: #4B5563;

      --success: #10B981; 
      --error: #DC2626; 
      --warning: #F59E0B;
      --error-rgb: 220, 38, 38;


      --primary-rgb: 37, 99, 235; 
      --accent-rgb: 217, 119, 6; 
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      min-height: 100vh;
      color: var(--text-primary);
      background: var(--bg-primary);
      display: flex;
      flex-direction: column; 
      overflow-x: hidden;
      padding-top: 70px; /* Space for fixed header */
      padding-bottom: 70px; /* Space for fixed bottom nav */
      line-height: 1.6;
    }

    .dashboard-header {
      width: 100%;
      background-color: var(--bg-secondary);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      border-bottom: 1px solid var(--border-primary);
      position: fixed; 
      top: 0;
      left: 0;
      z-index: 1000;
    }

    .dashboard-header .logo {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary);
      display: flex;
      align-items: center;
    }
    .dashboard-header .logo svg {
        width: 30px;
        height: 30px;
        fill: var(--primary);
        vertical-align: middle;
        margin-right: 8px;
    }
    
    .main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column; /* Changed to column for multiple sections */
        align-items: center; /* Center content horizontally */
        padding: 40px 20px;
    }
    
    @keyframes fadeInScaleUp {
         from {
             opacity: 0;
             transform: scale(0.95) translateY(20px);
         }
         to {
             opacity: 1;
             transform: scale(1) translateY(0);
         }
     }

    #posts-feed-container {
        width: 100%;
        max-width: 900px; 
    }

    .posts-feed-title {
        font-size: 1.8em;
        color: var(--text-primary);
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-primary);
    }

    .post-card {
        background-color: var(--bg-tertiary);
        border: 1px solid var(--border-secondary);
        border-radius: 10px;
        margin-bottom: 20px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        animation: fadeInScaleUp 0.5s ease-out forwards; 
        opacity: 0; 
        transform: scale(0.98);
    }
    .post-card img { 
        width: 100%;
        max-height: 400px;
        object-fit: cover; 
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid var(--border-primary);
        background-color: #000; 
    }
    .post-card .post-caption {
        font-size: 1em;
        color: var(--text-primary);
        margin-bottom: 10px;
        line-height: 1.5;
        text-align: left;
    }
    .post-card .post-meta {
        font-size: 0.8em;
        color: var(--text-muted);
        text-align: left;
        margin-bottom: 10px; /* Added margin for spacing before delete button */
    }
    .post-card .post-meta strong {
        color: var(--text-secondary);
    }

    .delete-post-btn {
        background-color: var(--error);
        color: var(--text-primary);
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        font-size: 0.8em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        display: inline-flex; /* Align icon and text */
        align-items: center;
        gap: 5px;
        margin-top: 10px; /* Space from meta */
        box-shadow: 0 2px 5px rgba(var(--error-rgb),0.15);
    }
    .delete-post-btn:hover {
        background-color: #EF4444; /* Darker error color */
        transform: translateY(-1px);
        box-shadow: 0 3px 7px rgba(var(--error-rgb),0.25);
    }
     .delete-post-btn svg {
        width: 12px; 
        height: 12px;
     }
    
    .video-wrapper {
        position: relative;
        width: 100%;
        background-color: #000; /* Black background for videos */
        border-radius: 8px; /* Match image radius */
        overflow: hidden; /* Keep controls contained */
        margin-bottom: 15px; /* Match image margin */
        border: 1px solid var(--border-primary); /* Match image border */
    }

    .video-wrapper video {
        width: 100%;
        display: block;
        max-height: 400px; /* Consistent max height */
        object-fit: contain; /* Use contain to see whole video, cover might crop */
        border-radius: 8px; /* Ensure video element itself has radius if wrapper padding is used */
    }

    .play-btn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(31, 41, 55, 0.7); /* --bg-secondary with alpha */
        color: var(--text-primary);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        z-index: 2;
        border: 2px solid var(--text-primary);
        transition: background-color 0.2s, transform 0.2s, border-color 0.2s, opacity 0.3s, display 0.3s;
    }

    .play-btn:hover {
        background-color: rgba(31, 41, 55, 0.9);
        transform: translate(-50%, -50%) scale(1.05);
        border-color: var(--accent-hover);
    }
    .play-btn svg {
        width: 30px; /* Adjust icon size */
        height: 30px;
    }

    .video-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background-color: rgba(17, 24, 39, 0.6); /* --bg-primary with alpha */
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        z-index: 3;
    }
    .video-wrapper:hover .video-controls,
    .video-wrapper .video-controls.visible { 
        opacity: 1;
    }


    .seek-bar {
        width: 100%; /* Full width inside controls */
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        background: var(--border-secondary);
        outline: none;
        border-radius: 3px;
        cursor: pointer;
        flex-grow: 1;
        margin: 0 10px;
    }

    .seek-bar::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        background: var(--accent);
        border-radius: 50%;
        cursor: pointer;
    }

    .seek-bar::-moz-range-thumb {
        width: 16px;
        height: 16px;
        background: var(--accent);
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }
    
    .video-controls .time-display {
        font-size: 0.8em;
        color: var(--text-secondary);
        min-width: 70px; /* Space for MM:SS / MM:SS */
        text-align: center;
    }

    .video-controls .mute-btn {
        background: none;
        border: none;
        color: var(--text-primary);
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
    }
    .video-controls .mute-btn svg {
        width: 20px;
        height: 20px;
    }


    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: var(--bg-secondary);
        box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3); 
        border-top: 1px solid var(--border-primary);
        display: flex;
        justify-content: space-around; 
        align-items: center;
        padding: 10px 0;
        z-index: 1000;
        animation: slideUpNav 0.5s ease-out forwards;
        opacity: 0;
        transform: translateY(100%);
    }
    
    @keyframes slideUpNav {
        from {
            opacity: 0;
            transform: translateY(100%);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }


    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: var(--text-secondary);
        transition: color 0.3s ease, transform 0.2s ease;
        border: none;
        background: none;
        cursor: pointer; 
        padding: 5px 10px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        flex: 1; 
        text-align: center; 
    }

    .nav-item svg {
        width: 24px; 
        height: 24px;
        fill: currentColor; 
        margin-bottom: 3px;
        transition: transform 0.2s ease;
    }

    .nav-item:hover {
        color: var(--accent-hover);
        transform: translateY(-2px);
    }
    .nav-item:hover svg {
        transform: scale(1.1);
    }

    .nav-item.active {
        color: var(--accent);
        font-weight: bold;
    }
    .nav-item.active svg {
        filter: drop-shadow(0 0 3px var(--accent));
    }

    .nav-item span {
        font-size: 0.75em;
        font-weight: bold;
        letter-spacing: 0.5px;
    }
    #page-loader {
        display: flex;
        justify-content: center;
        align-items: center;
        height: calc(100vh - 140px); /* Full viewport height minus header and footer */
        text-align: center;
        color: var(--text-secondary);
    }
     #no-posts-message {
        text-align: center;
        color: var(--text-secondary);
        font-style: italic;
        margin-top: 20px;
    }
    #post-action-message {
        text-align: center;
        margin: 10px 0;
        padding: 8px;
        border-radius: 5px;
        font-weight: bold;
        display: none; /* Hidden by default */
    }
    #post-action-message.success {
        background-color: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border: 1px solid var(--success);
    }
    #post-action-message.error {
        background-color: rgba(220, 38, 38, 0.1);
        color: var(--error);
        border: 1px solid var(--error);
    }

  </style>
</head>
<body>

  <header class="dashboard-header">
    <div class="logo">
        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4Z" />
          <path d="M12 6C13.6569 6 15 7.34315 15 9C15 10.6569 13.6569 12 12 12C10.3431 12 9 10.6569 9 9C9 7.34315 10.3431 6 12 6Z" />
          <path d="M6 12C6 13.6569 7.34315 15 9 15C10.6569 15 12 13.6569 12 12H10C10 12.5523 9.55228 13 9 13C8.44772 13 8 12.5523 8 12H6Z" />
          <path d="M18 12C18 13.6569 16.6569 15 15 15C13.3431 15 12 13.6569 12 12H14C14 12.5523 14.4477 13 15 13C15.5523 13 16 12.5523 16 12H18Z" />
          <path d="M12 18C13.6569 18 15 16.6569 15 15H13C13 15.5523 12.5523 16 12 16C11.4477 16 11 15.5523 11 15H9C9 16.6569 10.3431 18 12 18Z" />
        </svg>
        Sophia Tech
    </div>
  </header>

  <div id="page-loader">
    <p>Loading Dashboard...</p>
  </div>

  <main class="main-content" style="display: none;">
    <div id="posts-feed-container">
        <h2 class="posts-feed-title">Latest Updates</h2>
        <div id="post-action-message"></div>
        <div id="posts-feed">
            <!-- Posts will be loaded here by JavaScript -->
        </div>
        <p id="no-posts-message" style="display:none;">No updates posted yet.</p>
    </div>
  </main>

  <nav class="bottom-nav">
    <a href="/dashboard" class="nav-item active">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 4h6v6H4zm0 10h6v6H4zm10-10h6v6h-6zm0 10h6v6h-6z"/>
        </svg>
        <span>Dashboard</span>
    </a>
     <a href="/panel" class="nav-item" id="admin-panel-link" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12.74 2.32a1 1 0 0 0-1.48 0l-9 9A1 1 0 0 0 3 13h1v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7h1a1 1 0 0 0 .74-1.68l-9-9zM12 4.5l5 5V12h-2v-1a1 1 0 0 0-2 0v1H9V10c0-.47-.14-.93-.4-1.32L5 5.8V5h7zm-1 11v-1h2v1h-2zM5 19v-5h14v5H5z"/>
            <path d="M15.71 14.29a1 1 0 0 0-1.42 1.42L16 17.42V20h-2v-2.58l-1.71-1.71a1 1 0 0 0-1.42 0 1 1 0 0 0 0 1.42L12.58 19H11a1 1 0 0 0-.71.29 1 1 0 0 0-.21.33 1 1 0 0 0 .21 1.07 1 1 0 0 0 .71.29h3a1 1 0 0 0 .71-.29 1 1 0 0 0 .21-1.07 1 1 0 0 0-.21-.33A1 1 0 0 0 13 19h-.58l1.71-1.71a1 1 0 0 0 .03-.02 1 1 0 0 0-.03-1.42z"/>
        </svg>
        <span>Panel</span>
    </a>
    <a href="/inbox" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/></svg>
        <span>Inbox</span>
    </a>
    <a href="/profile" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        <span>Profile</span>
    </a>
  </nav>

  <script>
    let currentPlayingVideo = null;
    let isSeeking = false; 
    let hideControlsTimeoutId = null;
    const postActionMessageDiv = document.getElementById('post-action-message');


    function showPostActionMessage(message, type = 'neutral', duration = 3000) {
        if (postActionMessageDiv) {
            postActionMessageDiv.textContent = message;
            postActionMessageDiv.className = 'post-action-message'; 
            if (type) {
                postActionMessageDiv.classList.add(type);
            }
            postActionMessageDiv.style.display = 'block';

            if (duration > 0 && (type === 'success' || type === 'error')) { 
                setTimeout(() => {
                    if (postActionMessageDiv.textContent === message) { 
                        postActionMessageDiv.style.display = 'none';
                        postActionMessageDiv.textContent = '';
                    }
                }, duration);
            }
        }
    }


    function clearHideControlsTimer() {
        if (hideControlsTimeoutId) {
            clearTimeout(hideControlsTimeoutId);
            hideControlsTimeoutId = null;
        }
    }

    function startOrResetHideControlsTimer(postId) {
        clearHideControlsTimer();
        const video = document.getElementById(`vid_${postId}`);
        const playButton = document.querySelector(`.play-btn[data-post-id="${postId}"]`);
        const videoControls = video.closest('.video-wrapper').querySelector('.video-controls');

        if (video && !video.paused && document.body.contains(video)) {
            hideControlsTimeoutId = setTimeout(() => {
                if (video && !video.paused && document.body.contains(video)) {
                    if (playButton) playButton.style.display = 'none';
                    if (videoControls) videoControls.classList.remove('visible');
                }
            }, 3000);
        }
    }


    function playVideo(postId, button) {
        const videoId = `vid_${postId}`;
        const video = document.getElementById(videoId);
        if (!video) return;

        const videoWrapper = video.closest('.video-wrapper');
        const videoControls = videoWrapper.querySelector('.video-controls');
        const playButton = button || videoWrapper.querySelector(`.play-btn[data-post-id="${postId}"]`);


        // Pause any other playing video
        document.querySelectorAll('video').forEach(otherVideo => {
            if (otherVideo !== video && !otherVideo.paused) {
                otherVideo.pause();
                const otherPostId = otherVideo.id.substring(4);
                const oldButton = document.querySelector(`.play-btn[data-post-id="${otherPostId}"]`);
                if (oldButton) {
                    oldButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>'; // Play icon
                    oldButton.classList.remove('playing');
                    oldButton.style.display = 'flex'; // Ensure it's visible if it was hidden
                }
                const oldControls = otherVideo.closest('.video-wrapper').querySelector('.video-controls');
                if (oldControls) oldControls.classList.remove('visible');
            }
        });
        
        clearHideControlsTimer(); // Clear any existing timer before changing state

        if (video.paused) {
            video.play().catch(e => console.error("Error playing video:", e));
            playButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>'; // Pause icon
            playButton.classList.add('playing');
            currentPlayingVideo = video;
            playButton.style.display = 'flex';
            if (videoControls) videoControls.classList.add('visible');
            startOrResetHideControlsTimer(postId);
        } else {
            video.pause();
            playButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>'; // Play icon
            playButton.classList.remove('playing');
            currentPlayingVideo = null;
            playButton.style.display = 'flex'; // Keep visible on manual pause
            if (videoControls) videoControls.classList.add('visible'); // Keep controls visible on manual pause (if hovered)
        }
    }

    function seekVideo(postId, value) {
        const video = document.getElementById(`vid_${postId}`);
        if (video) {
            video.currentTime = value;
        }
         // User interaction, so reset timer
        startOrResetHideControlsTimer(postId);
    }

    function toggleMute(postId, button) {
        const video = document.getElementById(`vid_${postId}`);
        if(video) {
            video.muted = !video.muted;
            const volumeOnIcon = button.querySelector('.volume-on');
            const volumeOffIcon = button.querySelector('.volume-off');
            if(video.muted) {
                if(volumeOnIcon) volumeOnIcon.style.display = 'none';
                if(volumeOffIcon) volumeOffIcon.style.display = 'inline';
            } else {
                if(volumeOnIcon) volumeOnIcon.style.display = 'inline';
                if(volumeOffIcon) volumeOffIcon.style.display = 'none';
            }
        }
        // User interaction, so reset timer
        startOrResetHideControlsTimer(postId);
    }
    
    function formatVideoTime(timeInSeconds) {
        if (isNaN(timeInSeconds) || timeInSeconds < 0) return "0:00";
        const minutes = Math.floor(timeInSeconds / 60);
        const seconds = Math.floor(timeInSeconds % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
    }

    function setupVideoEvents(videoElement) {
        const postId = videoElement.id.substring(4); 
        const videoWrapper = videoElement.closest('.video-wrapper');
        const playButton = videoWrapper.querySelector(`.play-btn[data-post-id="${postId}"]`);
        const seekBar = videoWrapper.querySelector(`#seek_${postId}`);
        const currentTimeDisplay = videoWrapper.querySelector(`#current_time_${postId}`);
        const durationDisplay = videoWrapper.querySelector(`#duration_${postId}`);
        const videoControls = videoWrapper.querySelector('.video-controls');


        videoElement.addEventListener('loadedmetadata', () => {
            if (seekBar) seekBar.max = videoElement.duration;
            if (durationDisplay) durationDisplay.textContent = formatVideoTime(videoElement.duration);
            if (currentTimeDisplay) currentTimeDisplay.textContent = formatVideoTime(0);
        });

        videoElement.addEventListener('timeupdate', () => {
            if (seekBar && !isSeeking) seekBar.value = videoElement.currentTime;
            if (currentTimeDisplay) currentTimeDisplay.textContent = formatVideoTime(videoElement.currentTime);
        });
        
        videoElement.addEventListener('play', () => {
            if (playButton) playButton.style.display = 'flex';
            if (videoControls) videoControls.classList.add('visible');
            startOrResetHideControlsTimer(postId);
        });
        
        videoElement.addEventListener('pause', () => {
            clearHideControlsTimer();
            if (playButton) playButton.style.display = 'flex'; // Ensure play button is visible when paused
            // Controls visibility on pause is handled by mouseleave or explicit pause action
        });


        videoElement.addEventListener('ended', () => {
            clearHideControlsTimer();
            if (playButton) {
                playButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>'; // Play icon
                playButton.classList.remove('playing');
                playButton.style.display = 'flex';
            }
            if (seekBar) seekBar.value = 0; 
            if (currentTimeDisplay) currentTimeDisplay.textContent = formatVideoTime(0);
            currentPlayingVideo = null;
            if (videoControls) videoControls.classList.remove('visible');
        });
        
        videoElement.addEventListener('click', (e) => {
            if (e.target === videoElement && playButton) {
                 playButton.click();
            }
        });

        if (seekBar) { 
            seekBar.addEventListener('mousedown', () => { isSeeking = true; clearHideControlsTimer(); });
            seekBar.addEventListener('mouseup', () => { isSeeking = false; startOrResetHideControlsTimer(postId);});
            seekBar.addEventListener('input', function() { 
                seekVideo(postId, this.value);
            });
             seekBar.addEventListener('change', function() {
                seekVideo(postId, this.value);
            });
        }
        
        videoWrapper.addEventListener('mouseenter', () => {
            clearHideControlsTimer();
            if(playButton) playButton.style.display = 'flex';
            if(videoControls) videoControls.classList.add('visible');
        });

        videoWrapper.addEventListener('mouseleave', () => {
            if (!videoElement.paused) {
                startOrResetHideControlsTimer(postId);
            } else {
                 // If paused, and mouse leaves wrapper, hide bottom controls unless they are being hovered.
                 // The main play button remains visible.
                if (videoControls && !videoControls.matches(':hover')) {
                     videoControls.classList.remove('visible');
                }
            }
        });
    }


    document.addEventListener('DOMContentLoaded', () => {
        const mainContentElement = document.querySelector('.main-content');
        const pageLoaderElement = document.getElementById('page-loader');
        const adminPanelLink = document.getElementById('admin-panel-link');
        
        if (mainContentElement) mainContentElement.style.display = 'none';
        if (pageLoaderElement) pageLoaderElement.style.display = 'flex';

        const loggedInUserString = localStorage.getItem('loggedInUser');

        if (!loggedInUserString) {
            window.location.href = '/login';
            return;
        }

        let userFromStorage;
        try {
            userFromStorage = JSON.parse(loggedInUserString);
            if (!userFromStorage || !userFromStorage.id) {
                throw new Error("Invalid user data in localStorage");
            }
        } catch (error) {
            console.error('Error parsing user data from localStorage:', error);
            localStorage.removeItem('loggedInUser');
            window.location.href = '/login';
            return;
        }
        
        if (userFromStorage.role === 'admin' && adminPanelLink) {
            adminPanelLink.style.display = 'flex';
        }

        fetch(`/auth/verify-user/${userFromStorage.id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`User verification failed: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.isValid && data.user) {
                    loadPosts(data.user); 
                    if (mainContentElement) {
                        mainContentElement.style.display = 'flex';
                        mainContentElement.style.animation = 'fadeInScaleUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
                    }
                } else {
                    localStorage.removeItem('loggedInUser');
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Error during user verification process:', error);
                localStorage.removeItem('loggedInUser');
                window.location.href = '/login';
            })
            .finally(() => {
                if (pageLoaderElement) pageLoaderElement.style.display = 'none';
            });
    });


    function formatDate(isoString) {
        if (!isoString) return 'Unknown date';
        const date = new Date(isoString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }
    
    async function handleDeletePost(postId, buttonElement) {
        if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
            return;
        }
        showPostActionMessage('Deleting post...', 'neutral', 0); // Keep showing until done
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="animate-spin" style="width:12px; height:12px; margin-right:5px;"><path d="M12 2v2a8 8 0 110 16v2a10 10 0 100-20zm0 10a2 2 0 100-4 2 2 0 000 4z"></path></svg>Deleting...';


        try {
            const response = await fetch(`/api/admin/posts/${postId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showPostActionMessage('Post deleted successfully!', 'success');
                const postCard = buttonElement.closest('.post-card');
                if (postCard) {
                    postCard.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                    postCard.style.opacity = '0';
                    postCard.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        postCard.remove();
                         const postsFeedDiv = document.getElementById('posts-feed');
                         const noPostsMessage = document.getElementById('no-posts-message');
                         if (postsFeedDiv.children.length === 0) {
                            noPostsMessage.style.display = 'block';
                         }
                    }, 500);
                }
            } else {
                showPostActionMessage(result.message || 'Failed to delete post.', 'error');
                buttonElement.disabled = false;
                buttonElement.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"></path></svg>Delete Post';
            }
        } catch (error) {
            console.error('Error deleting post:', error);
            showPostActionMessage('An error occurred. Please try again.', 'error');
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"></path></svg>Delete Post';
        }
    }


    async function loadPosts(currentUser) { 
        const postsFeedDiv = document.getElementById('posts-feed');
        const noPostsMessage = document.getElementById('no-posts-message');
        if (!postsFeedDiv || !noPostsMessage) return;

        try {
            const response = await fetch('/api/posts');
            if (!response.ok) throw new Error('Failed to fetch posts');
            const posts = await response.json();

            postsFeedDiv.innerHTML = ''; 

            if (posts && posts.length > 0) {
                noPostsMessage.style.display = 'none';
                posts.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = 'post-card';
                    postCard.dataset.postId = post.id;
                    
                    let authorDisplay = post.authorUsername || 'Sophia Tech Admin';
                    if (post.authorId && currentUser && post.authorId === currentUser.id) {
                        authorDisplay = 'You';
                    }

                    let mediaElement = '';
                    const isImage = post.mimetype && post.mimetype.startsWith('image/');
                    const isVideo = post.mimetype && post.mimetype.startsWith('video/');

                    if (isImage) {
                        mediaElement = `<img src="${post.imageUrl}" alt="Post content">`;
                    } else if (isVideo) {
                        mediaElement = `
                        <div class="video-wrapper" data-post-id="${post.id}">
                            <video id="vid_${post.id}" playsinline>
                                <source src="${post.imageUrl}" type="${post.mimetype}">
                                Your browser does not support the video tag.
                            </video>
                            <button class="play-btn" data-post-id="${post.id}" onclick="playVideo('${post.id}', this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                            </button>
                            <div class="video-controls">
                                <input class="seek-bar" id="seek_${post.id}" type="range" value="0" step="0.1">
                                <span class="time-display"><span id="current_time_${post.id}">0:00</span> / <span id="duration_${post.id}">0:00</span></span>
                                <button class="mute-btn" onclick="toggleMute('${post.id}', this)">
                                    <svg class="volume-on" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                                    <svg class="volume-off" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                                </button>
                            </div>
                        </div>`;
                    } else if (post.imageUrl) { 
                        // Fallback for unknown type but existing imageUrl, try to guess
                        if (/\.(jpeg|jpg|gif|png|webp)$/i.test(post.imageUrl)) {
                             mediaElement = `<img src="${post.imageUrl}" alt="Post content">`;
                        } else { // Assume video if not a common image extension
                             mediaElement = `
                             <div class="video-wrapper" data-post-id="${post.id}">
                                <video id="vid_${post.id}" playsinline>
                                    <source src="${post.imageUrl}" type="video/mp4"> 
                                    Your browser does not support the video tag.
                                </video>
                                <button class="play-btn" data-post-id="${post.id}" onclick="playVideo('${post.id}', this)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                </button>
                                <div class="video-controls">
                                   <input class="seek-bar" id="seek_${post.id}" type="range" value="0" step="0.1">
                                   <span class="time-display"><span id="current_time_${post.id}">0:00</span> / <span id="duration_${post.id}">0:00</span></span>
                                   <button class="mute-btn" onclick="toggleMute('${post.id}', this)">
                                        <svg class="volume-on" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                                        <svg class="volume-off" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                                    </button>
                                </div>
                            </div>`;
                        }
                    }
                    
                    let deleteButtonHtml = '';
                    if (currentUser && currentUser.role === 'admin') {
                        deleteButtonHtml = `
                            <button class="delete-post-btn" onclick="handleDeletePost('${post.id}', this)">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                                Delete Post
                            </button>`;
                    }

                    postCard.innerHTML = `
                        ${mediaElement}
                        <p class="post-caption">${post.caption || ''}</p>
                        <p class="post-meta">Posted by <strong>${authorDisplay}</strong> on ${formatDate(post.timestamp)}</p>
                        ${deleteButtonHtml}
                    `;
                    postsFeedDiv.appendChild(postCard);

                    if (isVideo || (post.imageUrl && !/\.(jpeg|jpg|gif|png|webp)$/i.test(post.imageUrl))) {
                        const videoElement = postCard.querySelector('video');
                        if (videoElement) {
                            setupVideoEvents(videoElement);
                        }
                    }
                });
            } else {
                noPostsMessage.style.display = 'block';
                noPostsMessage.textContent = 'No updates posted yet.'; 
            }
        } catch (error) {
            console.error('Error loading posts:', error);
            noPostsMessage.textContent = 'Could not load updates at this time.';
            noPostsMessage.style.display = 'block';
            noPostsMessage.style.color = 'var(--error)';
        }
    }
  </script>
</body>
</html>
