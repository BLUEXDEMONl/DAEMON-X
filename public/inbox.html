<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inbox | Sophia Tech</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563EB; 
      --primary-dark: #1D4ED8; 
      --accent: #D97706; 
      --accent-hover: #F59E0B; 

      --bg-primary: #111827; 
      --bg-secondary: #1F2937; 
      --bg-tertiary: #2d3748; 

      --text-primary: #E5E7EB; 
      --text-secondary: #9CA3AF; 
      --text-muted: #6B7280;
      
      --border-primary: #374151; 
      --border-secondary: #4B5563;

      --success: #10B981; 
      --error: #DC2626; 
      --warning: #F59E0B;

      --primary-rgb: 37, 99, 235; 
      --accent-rgb: 217, 119, 6; 
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      min-height: 100vh;
      color: var(--text-primary);
      background: var(--bg-primary);
      display: flex;
      flex-direction: column; 
      overflow-x: hidden;
      padding-top: 70px; 
      padding-bottom: 70px; 
      line-height: 1.6;
    }

    .dashboard-header {
      width: 100%;
      background-color: var(--bg-secondary);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      border-bottom: 1px solid var(--border-primary);
      position: fixed; 
      top: 0;
      left: 0;
      z-index: 1000;
    }

    .dashboard-header .logo {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary);
      display: flex;
      align-items: center;
    }
    .dashboard-header .logo svg {
        width: 30px;
        height: 30px;
        fill: var(--primary);
        vertical-align: middle;
        margin-right: 8px;
    }
    
    .main-content {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: flex-start; 
        padding: 40px 20px;
    }
    
    @keyframes fadeInScaleUp {
         from {
             opacity: 0;
             transform: scale(0.95) translateY(20px);
         }
         to {
             opacity: 1;
             transform: scale(1) translateY(0);
         }
     }

    .content-card-wrapper {
        background-color: var(--bg-secondary);
        padding: 30px 35px 40px 35px; 
        border-radius: 12px;
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4); 
        width: 100%;
        max-width: 900px; 
        border: 1px solid var(--border-primary);
    }

    .content-card-wrapper h1 {
      font-size: 2em;
      margin-bottom: 25px; 
      color: var(--text-primary);
      text-align: center; 
      border-bottom: 1px solid var(--border-primary);
      padding-bottom: 15px;
    }

    #chat-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }

    .chat-list-item {
        background-color: var(--bg-tertiary); 
        border: 1px solid var(--border-secondary); 
        border-radius: 8px;
        margin-bottom: 12px;
        transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    .chat-list-item:hover {
        background-color: #2d3748; 
        border-color: var(--primary); 
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(var(--primary-rgb), 0.2); 
    }

    .chat-list-item a {
        display: flex;
        align-items: center;
        padding: 15px;
        text-decoration: none;
        color: var(--text-primary);
    }

    .chat-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background-color: var(--bg-primary); 
        margin-right: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
        border: 2px solid var(--border-secondary); 
    }
    .chat-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
     .chat-avatar svg { 
        width: 60%;
        height: 60%;
        fill: var(--text-secondary);
     }

    .chat-info {
        flex-grow: 1;
        overflow: hidden; 
    }

    .chat-username-container {
        display: flex;
        align-items: center;
        font-weight: bold;
        font-size: 1.05em;
        margin-bottom: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-primary);
    }
    .chat-username-container .username-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .verification-badge-inbox {
        display: inline-flex;
        align-items: center;
        margin-left: 5px;
        flex-shrink: 0; 
        color: var(--success); /* Badge color */
    }
    .verification-badge-inbox svg {
        width: 14px; /* Adjust size as needed */
        height: 14px;
       /* fill is currentColor by default if not set in SVG path */
    }

    .last-message {
        font-size: 0.85em;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-meta {        
        text-align: right;
        font-size: 0.8em;
        color: var(--text-secondary);
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        min-width: 60px; 
    }
    .chat-timestamp {        
        margin-bottom: 5px;
    }
    .unread-indicator {
        width: 10px;
        height: 10px;
        background-color: var(--success); 
        border-radius: 50%;
        display: none; 
        box-shadow: 0 0 8px var(--success); 
    }
     .chat-list-item.unread .unread-indicator {
        display: block;
     }
     .chat-list-item.unread .last-message {
        font-weight: bold;
        color: var(--text-primary);
     }

    #no-chats-message {
        text-align: center;
        color: var(--text-secondary);
        font-weight: bold;
        padding: 20px 0;
        display: none; 
    }
    
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: var(--bg-secondary);
        box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3); 
        border-top: 1px solid var(--border-primary);
        display: flex;
        justify-content: space-around; 
        align-items: center;
        padding: 10px 0;
        z-index: 1000;
        animation: slideUpNav 0.5s ease-out forwards;
        opacity: 0;
        transform: translateY(100%);
    }
    
    @keyframes slideUpNav {
        from {
            opacity: 0;
            transform: translateY(100%);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: var(--text-secondary);
        transition: color 0.3s ease, transform 0.2s ease;
        border: none;
        background: none;
        cursor: pointer; 
        padding: 5px 10px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        flex: 1; 
        text-align: center; 
    }

    .nav-item svg {
        width: 24px; 
        height: 24px;
        fill: currentColor; 
        margin-bottom: 3px;
        transition: transform 0.2s ease;
    }

    .nav-item:hover {
        color: var(--accent-hover);
        transform: translateY(-2px);
    }
    .nav-item:hover svg {
        transform: scale(1.1);
    }

    .nav-item.active {
        color: var(--accent);
        font-weight: bold;
    }
    .nav-item.active svg {
        filter: drop-shadow(0 0 3px var(--accent));
    }

    .nav-item span {
        font-size: 0.75em;
        font-weight: bold;
        letter-spacing: 0.5px;
    }
     #page-loader {
        display: flex;
        justify-content: center;
        align-items: center;
        height: calc(100vh - 140px);
        text-align: center;
        color: var(--text-secondary);
    }
  </style>
</head>
<body>

  <header class="dashboard-header">
    <div class="logo">
        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4Z" />
          <path d="M12 6C13.6569 6 15 7.34315 15 9C15 10.6569 13.6569 12 12 12C10.3431 12 9 10.6569 9 9C9 7.34315 10.3431 6 12 6Z" />
          <path d="M6 12C6 13.6569 7.34315 15 9 15C10.6569 15 12 13.6569 12 12H10C10 12.5523 9.55228 13 9 13C8.44772 13 8 12.5523 8 12H6Z" />
          <path d="M18 12C18 13.6569 16.6569 15 15 15C13.3431 15 12 13.6569 12 12H14C14 12.5523 14.4477 13 15 13C15.5523 13 16 12.5523 16 12H18Z" />
          <path d="M12 18C13.6569 18 15 16.6569 15 15H13C13 15.5523 12.5523 16 12 16C11.4477 16 11 15.5523 11 15H9C9 16.6569 10.3431 18 12 18Z" />
        </svg>
        Sophia Tech
    </div>
  </header>

  <div id="page-loader">
    <p>Loading Inbox...</p>
  </div>

  <main class="main-content" style="display: none;">
    <div class="content-card-wrapper">
        <h1>Inbox</h1>
        <ul id="chat-list">
            <!-- Chat items will be populated here by JavaScript -->
        </ul>
        <p id="no-chats-message" style="display: none;">You have no active conversations.</p>
    </div>
  </main>

  <nav class="bottom-nav">
    <a href="/dashboard" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 4h6v6H4zm0 10h6v6H4zm10-10h6v6h-6zm0 10h6v6h-6z"/>
        </svg>
        <span>Dashboard</span>
    </a>
    <a href="/panel" class="nav-item" id="admin-panel-link" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
             <path d="M12.74 2.32a1 1 0 0 0-1.48 0l-9 9A1 1 0 0 0 3 13h1v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7h1a1 1 0 0 0 .74-1.68l-9-9zM12 4.5l5 5V12h-2v-1a1 1 0 0 0-2 0v1H9V10c0-.47-.14-.93-.4-1.32L5 5.8V5h7zm-1 11v-1h2v1h-2zM5 19v-5h14v5H5z"/>
            <path d="M15.71 14.29a1 1 0 0 0-1.42 1.42L16 17.42V20h-2v-2.58l-1.71-1.71a1 1 0 0 0-1.42 0 1 1 0 0 0 0 1.42L12.58 19H11a1 1 0 0 0-.71.29 1 1 0 0 0-.21.33 1 1 0 0 0 .21 1.07 1 1 0 0 0 .71.29h3a1 1 0 0 0 .71-.29 1 1 0 0 0 .21-1.07 1 1 0 0 0-.21-.33A1 1 0 0 0 13 19h-.58l1.71-1.71a1 1 0 0 0 .03-.02 1 1 0 0 0-.03-1.42z"/>
        </svg>
        <span>Panel</span>
    </a>
    <a href="/inbox" class="nav-item active">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/></svg>
        <span>Inbox</span>
    </a>
    <a href="/profile" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        <span>Profile</span>
    </a>
  </nav>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const mainContentElement = document.querySelector('.main-content');
        const pageLoaderElement = document.getElementById('page-loader');
        const adminPanelLink = document.getElementById('admin-panel-link');

        if (mainContentElement) mainContentElement.style.display = 'none';
        if (pageLoaderElement) pageLoaderElement.style.display = 'flex';

        const loggedInUserString = localStorage.getItem('loggedInUser');

        if (!loggedInUserString) {
            window.location.href = '/login';
            return;
        }

        let userFromStorage;
        try {
            userFromStorage = JSON.parse(loggedInUserString);
            if (!userFromStorage || !userFromStorage.id) {
                throw new Error("Invalid user data in localStorage");
            }
        } catch (error) {
            console.error('Error parsing user data from localStorage:', error);
            localStorage.removeItem('loggedInUser');
            window.location.href = '/login';
            return;
        }
        
        if (userFromStorage.role === 'admin' && adminPanelLink) {
            adminPanelLink.style.display = 'flex';
        }

        fetch(`/auth/verify-user/${userFromStorage.id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`User verification failed: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.isValid) {
                    initializeInboxPage(userFromStorage);
                    if (mainContentElement) {
                         mainContentElement.style.display = 'flex';
                         mainContentElement.style.animation = 'fadeInScaleUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
                    }
                    if (pageLoaderElement) pageLoaderElement.style.display = 'none';
                } else {
                    localStorage.removeItem('loggedInUser');
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Error during user verification process:', error);
                localStorage.removeItem('loggedInUser');
                window.location.href = '/login';
            });
    });

    function formatInboxTimestamp(isoString) {
        if (!isoString) return '';
        try {
            const date = new Date(isoString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        } catch (e) {
            return '';
        }
    }

    function createChatListItem(session, currentUserId) {
        const listItem = document.createElement('li');
        listItem.className = 'chat-list-item';

        if (session.lastMessage && session.lastMessage.senderId && session.lastMessage.senderId !== currentUserId) {
            // This is a basic unread indicator. True unread status needs backend support.
            // For now, if the last message isn't from the current user, consider it potentially unread.
            // The actual "read" status would require tracking if the user has opened and viewed this chat.
            listItem.classList.add('unread');
        }

        const avatarContent = session.otherUser.avatarUrl
            ? `<img src="${session.otherUser.avatarUrl}" alt="${session.otherUser.username}'s Avatar">`
            : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>`;

        const lastMessageText = session.lastMessage.senderId === currentUserId 
            ? `You: ${session.lastMessage.text}` 
            : session.lastMessage.text;

        let verificationBadgeInboxHtml = '';
        if (session.otherUser.verified) {
            verificationBadgeInboxHtml = `
                <span class="verification-badge-inbox" title="Verified User">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.9388 1.13669C11.4793 0.449229 12.5208 0.44923 13.0613 1.13669L14.808 3.35829L17.527 2.58767C18.3683 2.34921 19.2109 2.96138 19.2441 3.83525L19.3514 6.65926L22.004 7.63397C22.8249 7.93559 23.1467 8.92611 22.6599 9.6526L21.0868 12.0003L22.6599 14.3481C23.1467 15.0746 22.8249 16.0651 22.004 16.3667L19.3514 17.3414L19.2441 20.1654C19.2109 21.0393 18.3683 21.6515 17.527 21.413L14.808 20.6424L13.0613 22.864C12.5208 23.5515 11.4793 23.5515 10.9388 22.864L9.19206 20.6424L6.47311 21.413C5.63175 21.6515 4.78916 21.0393 4.75596 20.1654L4.64866 17.3414L1.99603 16.3667C1.17519 16.0651 0.853351 15.0746 1.34014 14.3481L2.91324 12.0003L1.34013 9.6526C0.85335 8.92611 1.17519 7.93559 1.99603 7.63397L4.64866 6.65926L4.75596 3.83525C4.78916 2.96138 5.63175 2.34921 6.47311 2.58767L9.19206 3.35829L10.9388 1.13669ZM8.35859 11.8486C8.65148 11.5557 9.12635 11.5557 9.41925 11.8486L10.8889 13.3182L14.3586 9.84858C14.6515 9.55568 15.1264 9.55568 15.4192 9.84858C15.7121 10.1415 15.7121 10.6163 15.4192 10.9092L11.4192 14.9092C11.1264 15.2021 10.6515 15.2021 10.3586 14.9092L8.35859 12.9092C8.06569 12.6163 8.06569 12.1415 8.35859 11.8486Z" clip-rule="evenodd"></path>
                    </svg>
                </span>`;
        }

        listItem.innerHTML = `
            <a href="/chat/${session.otherUser.id}?receiverUsername=${encodeURIComponent(session.otherUser.username)}">
                <div class="chat-avatar">${avatarContent}</div>
                <div class="chat-info">
                    <div class="chat-username-container">
                        <span class="username-text">${session.otherUser.username || 'Unknown User'}</span>
                        ${verificationBadgeInboxHtml}
                    </div>
                    <div class="last-message">${lastMessageText || 'No messages yet...'}</div>
                </div>
                <div class="chat-meta">
                    <span class="chat-timestamp">${formatInboxTimestamp(session.lastMessage.timestamp)}</span>
                    <span class="unread-indicator"></span>
                </div>
            </a>
        `;
        return listItem;
    }


    async function loadInboxConversations(currentUser) {
        const chatListUL = document.getElementById('chat-list');
        const noChatsMessage = document.getElementById('no-chats-message');
        const pageLoader = document.getElementById('page-loader'); 

        if (!currentUser || !currentUser.id) {
            noChatsMessage.textContent = 'Error: User not identified.';
            noChatsMessage.style.display = 'block';
            if(pageLoader) pageLoader.style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`/api/inbox-sessions/${currentUser.id}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Failed to fetch conversations' }));
                throw new Error(errorData.message || `Server error ${response.status}`);
            }
            const data = await response.json();

            chatListUL.innerHTML = ''; 

            if (data.success && data.sessions && data.sessions.length > 0) {
                data.sessions.forEach(session => {
                    const listItem = createChatListItem(session, currentUser.id);
                    chatListUL.appendChild(listItem);
                });
                noChatsMessage.style.display = 'none';
            } else {
                noChatsMessage.textContent = 'You have no active conversations.';
                noChatsMessage.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading inbox conversations:', error);
            noChatsMessage.textContent = `Error loading conversations: ${error.message}`;
            noChatsMessage.style.display = 'block';
            noChatsMessage.style.color = 'var(--error)'; 
        } finally {
             if(pageLoader) pageLoader.style.display = 'none';
             const mainContent = document.querySelector('.main-content');
             if (mainContent) mainContent.style.display = 'flex';
        }
    }


    function initializeInboxPage(currentUser) {
        if (currentUser.role === 'admin') {
            // Admin specific inbox logic can go here if needed in future
        }
        loadInboxConversations(currentUser);
    }
  </script>
</body>
</html>