<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat | Sophia Tech</title>
    <style>
        :root {
            --primary: #2563EB; 
            --primary-dark: #1D4ED8; 
            --accent: #D97706; 
            --accent-hover: #F59E0B; 

            --bg-primary: #111827; 
            --bg-secondary: #1F2937; 
            --bg-tertiary: #2d3748; 

            --text-primary: #E5E7EB; 
            --text-secondary: #9CA3AF; 
            --text-muted: #6B7280;
            
            --border-primary: #374151; 
            --border-secondary: #4B5563;

            --success: #10B981; 
            --error: #DC2626; 
            --warning: #F59E0B;
            
            --message-self-bg: #2563EB; 
            --message-other-bg: #374151;
            --chat-header-bg: #1F2937;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: var(--bg-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text-primary);
        }

        .chat-page-container {
            display: flex;
            margin: 0;
            padding: 0;
            flex-direction: column;
            flex-grow: 1;
            height: 100vh; /* Full viewport height */
            max-height: 100vh;
        }

        .chat-header {
            width: 100%;
            background-color: var(--chat-header-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 10;
            flex-shrink: 0;
        }
        .chat-header a.back-link {
            color: var(--accent);
            text-decoration: none;
            margin-right: 15px;
            transition: color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .chat-header a.back-link:hover {
            color: var(--accent-hover);
        }
        .chat-header a.back-link svg {
            width: 24px; 
            height: 24px; 
            stroke-width: 2.5; 
        }
        .chat-header h1 {
            font-size: 1.3em;
            color: var(--text-primary);
            font-weight: bold;
        }
        
        .chat-messages-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px; 
            margin: 0;
        }

        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 75%;
            word-wrap: break-word;
            line-height: 1.4; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            position: relative; 
        }

        .message-bubble.self {
            background-color: var(--message-self-bg);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            color: var(--text-primary); 
        }

        .message-bubble.other {
            background-color: var(--message-other-bg);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            color: var(--text-primary); 
        }
        .message-bubble .sender {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 4px;
            color: var(--accent-hover); 
            display: flex; 
            align-items: center; 
        }
         .message-bubble.self .sender { 
            display: none; 
         }

        .verification-badge-chat {
            display: inline-flex;
            align-items: center;
            margin-left: 5px;
            color: var(--success); /* Badge color */
        }
        .verification-badge-chat svg {
           width: 14px; /* Adjust size as needed */
           height: 14px;
           /* fill is currentColor by default if not set in SVG path */
        }


        .message-bubble .timestamp {
            font-size: 0.7em;
            color: var(--text-muted); 
            display: block;
            text-align: right;
            margin-top: 5px;
        }
         .message-bubble.self .timestamp {
            color: rgba(229, 231, 235, 0.7); 
         }


        .chat-input-area {
            display: flex;
            padding: 15px 20px;
            background-color: var(--chat-header-bg); 
            border-top: 1px solid var(--border-primary);
            gap: 10px;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            flex-shrink: 0; 
        }

        #message-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-secondary);
            background-color: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 1em;
            color: var(--text-primary);
            outline: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        #message-input:focus {
            border-color: var(--primary); 
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb),0.3);
        }

        #send-button {
            padding: 10px 18px; 
            background: var(--accent);
            border: none;
            border-radius: 20px;
            font-size: 1em;
            color: var(--bg-primary);
            cursor: pointer;
            transition: background 0.3s ease, transform 0.15s ease;
            font-weight: bold;
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        #send-button:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }
        #send-button svg {
            width: 20px; 
            height: 20px;
            fill: currentColor;
        }

        #chat-status {
            text-align: center;
            padding: 8px 10px; 
            font-size: 0.8em;
            color: var(--text-secondary);
            flex-shrink: 0;
            background-color: var(--bg-primary); 
             border-bottom: 1px solid var(--border-primary);
         }
         .sophia-tech-powered {
            font-size: 0.75em;
            color: var(--text-muted);
            text-align: center;
            padding: 8px 0;
            background-color: var(--chat-header-bg);
            border-top: 1px solid var(--border-primary);
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="chat-page-container">
        <header class="chat-header">
            <a href="/inbox" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="19" y1="12" x2="5" y2="12"></line>
                  <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
            </a>
            <h1 id="chat-with-username">Chat</h1>
        </header>
        
        <div id="chat-status">Connecting...</div>

        <div class="chat-messages-area" id="chat-messages">
        </div>

        <div class="chat-input-area">
            <input type="text" id="message-input" placeholder="Type your message..." disabled>
            <button id="send-button" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
        <div class="sophia-tech-powered">
            Powered by Sophia Tech
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatStatus = document.getElementById('chat-status');
        const chatWithUsernameHeader = document.getElementById('chat-with-username');

        let currentUser = null;
        let receiverId = null;
        let receiverUsername = 'User'; 
        let chatRoomId = null;

        const socket = io();

        function getReceiverIdFromPath() {
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 3 && pathParts[1].toLowerCase() === 'chat') {
                return pathParts[2];
            }
            return null;
        }
         function getQueryParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            return params;
        }


        function generateChatRoomId(userId1, userId2) {
            if (!userId1 || !userId2) return null;
            return [userId1, userId2].sort().join('_');
        }
        
        function formatMessageTimestamp(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return '';
            }
        }

        function displayMessage(msgSenderUsername, text, timestamp, isSelf, senderIsVerified) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-bubble', isSelf ? 'self' : 'other');
            
            let verificationBadgeHtml = '';
            if (!isSelf && senderIsVerified) {
                verificationBadgeHtml = `
                    <span class="verification-badge-chat" title="Verified User">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M10.9388 1.13669C11.4793 0.449229 12.5208 0.44923 13.0613 1.13669L14.808 3.35829L17.527 2.58767C18.3683 2.34921 19.2109 2.96138 19.2441 3.83525L19.3514 6.65926L22.004 7.63397C22.8249 7.93559 23.1467 8.92611 22.6599 9.6526L21.0868 12.0003L22.6599 14.3481C23.1467 15.0746 22.8249 16.0651 22.004 16.3667L19.3514 17.3414L19.2441 20.1654C19.2109 21.0393 18.3683 21.6515 17.527 21.413L14.808 20.6424L13.0613 22.864C12.5208 23.5515 11.4793 23.5515 10.9388 22.864L9.19206 20.6424L6.47311 21.413C5.63175 21.6515 4.78916 21.0393 4.75596 20.1654L4.64866 17.3414L1.99603 16.3667C1.17519 16.0651 0.853351 15.0746 1.34014 14.3481L2.91324 12.0003L1.34013 9.6526C0.85335 8.92611 1.17519 7.93559 1.99603 7.63397L4.64866 6.65926L4.75596 3.83525C4.78916 2.96138 5.63175 2.34921 6.47311 2.58767L9.19206 3.35829L10.9388 1.13669ZM8.35859 11.8486C8.65148 11.5557 9.12635 11.5557 9.41925 11.8486L10.8889 13.3182L14.3586 9.84858C14.6515 9.55568 15.1264 9.55568 15.4192 9.84858C15.7121 10.1415 15.7121 10.6163 15.4192 10.9092L11.4192 14.9092C11.1264 15.2021 10.6515 15.2021 10.3586 14.9092L8.35859 12.9092C8.06569 12.6163 8.06569 12.1415 8.35859 11.8486Z" clip-rule="evenodd"></path>
                        </svg>
                    </span>`;
            }

            let senderDisplayHtml = '';
            if (!isSelf && msgSenderUsername) {
                senderDisplayHtml = `<div class="sender">${msgSenderUsername}${verificationBadgeHtml}</div>`;
            }

            const textNode = document.createElement('div'); 
            textNode.className = 'message-text-content';
            textNode.textContent = text; 

            messageDiv.innerHTML = `
                ${senderDisplayHtml}
                ${textNode.outerHTML}
                <div class="timestamp">${formatMessageTimestamp(timestamp)}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText && chatRoomId && currentUser && currentUser.id && receiverId) {
                const messageData = {
                    roomId: chatRoomId,
                    senderId: currentUser.id,
                    senderUsername: currentUser.username || 'Me',
                    senderVerified: currentUser.verified || false,
                    receiverId: receiverId, 
                    text: messageText,
                    timestamp: new Date().toISOString()
                };
                socket.emit('chat message', messageData);
                displayMessage(messageData.senderUsername, messageData.text, messageData.timestamp, true, messageData.senderVerified);
                messageInput.value = '';
            }
        }

        socket.on('connect', () => {
            chatStatus.textContent = 'Connected';
             if (currentUser && currentUser.id && receiverId) { 
                 chatRoomId = generateChatRoomId(currentUser.id, receiverId);
                 if (chatRoomId) {
                    socket.emit('join room', chatRoomId);
                    // chatStatus.textContent = `Chatting with ${receiverUsername}`; // Removed this line
                    socket.emit('request history', chatRoomId);
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                 } else {
                    chatStatus.textContent = 'Error: Could not establish chat room.';
                 }
             } else if (!currentUser || !currentUser.id) {
                 chatStatus.textContent = 'Error: Not logged in. Please login to chat.';
                 sendButton.disabled = true;
                 messageInput.disabled = true;
             } else if (!receiverId) {
                  chatStatus.textContent = 'Error: No recipient specified for chat.';
                  sendButton.disabled = true;
                  messageInput.disabled = true;
             }
        });

        socket.on('chat message', (msg) => {
            if (msg.roomId === chatRoomId && msg.senderId !== (currentUser ? currentUser.id : null)) {
                 displayMessage(msg.senderUsername || 'User', msg.text, msg.timestamp, false, msg.senderVerified);
            }
        });
        
        socket.on('message history', (history) => {
            chatMessages.innerHTML = ''; 
            if (Array.isArray(history)) {
                history.forEach(msg => {
                    const isSelf = msg.senderId === (currentUser ? currentUser.id : null);
                    displayMessage(msg.senderUsername, msg.text, msg.timestamp, isSelf, msg.senderVerified);
                });
            } else {
                console.warn("Received non-array message history:", history);
                chatStatus.textContent = "Could not load message history properly.";
            }
             chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        socket.on('disconnect', () => {
            chatStatus.textContent = 'Disconnected. Attempting to reconnect...';
        });
        socket.on('connect_error', (err) => {
            chatStatus.textContent = `Connection Error: ${err.message}`;
        });

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        async function initializeChat() {
            const loggedInUserString = localStorage.getItem('loggedInUser');
            if (!loggedInUserString) {
                chatStatus.textContent = 'Please log in to chat.';
                sendButton.disabled = true;
                messageInput.disabled = true;
                return;
            }
            try {
                currentUser = JSON.parse(loggedInUserString);
                if (!currentUser || !currentUser.id) throw new Error("Invalid user data");
            } catch (e) {
                chatStatus.textContent = 'Error loading user data. Please log in again.';
                return;
            }

            const params = getQueryParams();
            receiverId = getReceiverIdFromPath() || params.with; 

            if (params.receiverUsername) {
                receiverUsername = params.receiverUsername;
            } else if (receiverId && receiverId !== currentUser.id) { 
                 try { 
                     const response = await fetch(`/auth/verify-user/${receiverId}`);
                     if (response.ok) {
                         const data = await response.json();
                         if (data.success && data.user) {
                            receiverUsername = data.user.username || 'User';
                         }
                     }
                 } catch (err) { console.error("Error fetching receiver username:", err); }
            }
            
            if (receiverId && receiverId !== currentUser.id) {
                chatWithUsernameHeader.textContent = `Chat with ${receiverUsername}`;
                messageInput.disabled = false;
                sendButton.disabled = false;
                 if (socket.connected) { 
                    chatRoomId = generateChatRoomId(currentUser.id, receiverId);
                    if(chatRoomId) {
                        socket.emit('join room', chatRoomId);
                        // chatStatus.textContent = `Chatting with ${receiverUsername}`; // Removed this line
                        socket.emit('request history', chatRoomId);
                    }
                 }
            } else if (receiverId === currentUser.id) {
                chatWithUsernameHeader.textContent = 'Chat';
                chatStatus.textContent = 'You cannot chat with yourself.';
                sendButton.disabled = true;
                messageInput.disabled = true;
            } else {
                chatWithUsernameHeader.textContent = 'Chat';
                chatStatus.textContent = 'Select a user to chat with from your inbox.';
                sendButton.disabled = true;
                messageInput.disabled = true;
            }
        }

        document.addEventListener('DOMContentLoaded', initializeChat);

    </script>
</body>
</html>

    
