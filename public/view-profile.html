<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile | Sophia Tech</title>
    <style>
        :root {
            --primary: #2563EB; 
            --primary-dark: #1D4ED8; 
            --accent: #D97706; 
            --accent-hover: #F59E0B; 

            --bg-primary: #111827; 
            --bg-secondary: #1F2937; 
            --bg-tertiary: #2d3748; 

            --text-primary: #E5E7EB; 
            --text-secondary: #9CA3AF; 
            --text-muted: #6B7280;
            
            --border-primary: #374151; 
            --border-secondary: #4B5563;

            --success: #10B981; 
            --error: #DC2626; 
            --warning: #F59E0B;

            --primary-rgb: 37, 99, 235; 
            --accent-rgb: 217, 119, 6; 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: var(--bg-primary); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
            padding-top: 70px; 
            padding-bottom: 70px; 
            line-height: 1.6;
        }
        
        .dashboard-header {
          width: 100%;
          background-color: var(--bg-secondary); 
          padding: 15px 30px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
          border-bottom: 1px solid var(--border-primary);
          position: fixed; 
          top: 0;
          left: 0;
          z-index: 1000;
        }

        .dashboard-header .logo {
          font-size: 1.5em;
          font-weight: bold;
          color: var(--primary); 
          display: flex;
          align-items: center;
        }
        .dashboard-header .logo svg {
            width: 30px;
            height: 30px;
            fill: var(--primary); 
            vertical-align: middle;
            margin-right: 8px;
        }


        .main-content {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            padding: 40px 20px;
        }
        
         @keyframes fadeInScaleUp {
             from {
                 opacity: 0;
                 transform: scale(0.95) translateY(20px);
             }
             to {
                 opacity: 1;
                 transform: translateY(0);
             }
         }


        .profile-container {
            background-color: var(--bg-secondary);
            padding: 30px 35px 40px 35px; 
            border-radius: 12px;
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4); 
            width: 100%;
            max-width: 650px; 
            border: 1px solid var(--border-primary);
            text-align: center; 
        }

         .profile-header {
             margin-bottom: 30px; 
             display: flex;
             flex-direction: column;
             align-items: center;
             animation: slideDownInner 0.6s ease-out 0.5s forwards;
             opacity: 0;
             transform: translateY(-15px);
             position: relative; 
             border-bottom: 1px solid var(--border-primary);
             padding-bottom: 25px;
         }

         .avatar-container {
             width: 130px; 
             height: 130px;
             border-radius: 50%;
             background-color: var(--bg-tertiary);
             display: flex;
             justify-content: center;
             align-items: center;
             margin-bottom: 15px; 
             border: 4px solid var(--border-primary); 
             box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); 
             overflow: hidden;
             position: relative; 
             /* No cursor pointer for view-only profile */
        }
         
         #avatar-image {
             width: 100%;
             height: 100%;
             object-fit: cover; 
             display: block; 
         }

         .avatar-container svg#avatar-placeholder-svg { 
             width: 60%;
             height: 60%;
             fill: var(--text-secondary);
             opacity: 0.7;
         }

        .username-line {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }

         #profile-username-header {
             font-size: 1.8em; 
             font-weight: bold;
             color: var(--text-primary);
             word-break: break-word; 
         }
         #verification-badge-container {
             margin-left: 8px;
             display: inline-flex;
             align-items: center;
         }
         #verification-badge-container svg {
            width: 22px; 
            height: 22px;
            fill: var(--success);
         }

         #profile-header-email { 
            font-size: 0.95em;
            color: var(--text-secondary);
            word-break: break-all;
         }

        .page-title { 
             font-size: 2em;
             margin-bottom: 10px;
             color: var(--text-primary);
             font-weight: 600;
        }
        
        .profile-section-title {
            font-size: 1.3em;
            color: var(--text-primary);
            font-weight: bold;
            text-align: left;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-primary);
             animation: slideUpInner 0.6s ease-out 0.6s forwards;
             opacity: 0;
             transform: translateY(15px);
        }

        .profile-details {
             animation: slideUpInner 0.6s ease-out 0.7s forwards;
             opacity: 0;
             transform: translateY(15px);
             text-align: left; 
             margin-bottom: 30px; 
        }

        .profile-item {
            margin-bottom: 12px; 
            border-bottom: 1px solid var(--border-primary); 
            padding: 12px 8px; 
            display: flex;
            align-items: center;
             flex-wrap: wrap;
             gap: 8px 15px; 
             border-radius: 6px;
        }
        .profile-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .profile-item label {
            font-weight: bold;
            color: var(--text-secondary);
            width: 130px; 
            flex-shrink: 0;
            font-size: 0.9em; 
        }

        .profile-item span {
            font-size: 1em; 
            color: var(--text-primary);
            word-break: break-all;
             flex-grow: 1;
             min-width: 150px;
        }
        
        #profile-role { 
            text-transform: capitalize;
        }

        #message {
             margin-bottom: 25px; 
             text-align: center;
             font-weight: bold;
             min-height: 1.2em;
             font-size: 0.95em;
             transition: opacity 0.3s ease, color 0.3s ease;
             padding: 10px;
             border-radius: 6px;
             display: none; 
         }
         #message.success {
             color: var(--success);
             background-color: rgba(16, 185, 129, 0.1);
             border: 1px solid rgba(16, 185, 129, 0.3);
             display: block;
         }
         #message.error { 
             color: var(--error);
             background-color: rgba(220, 38, 38, 0.1);
             border: 1px solid rgba(220, 38, 38, 0.3);
             display: block;
         }

        .profile-actions-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
            align-items: center; /* Center buttons */
            animation: slideUpInner 0.6s ease-out 0.8s forwards;
            opacity: 0;
            transform: translateY(15px);
        }

        .profile-action-button {
            padding: 12px 25px; 
            border: none;
            border-radius: 8px;
            font-size: 1em;
            color: var(--text-primary); 
            cursor: pointer;
            transition: background 0.3s ease, transform 0.15s ease, box-shadow 0.2s ease;
            font-weight: bold;
            letter-spacing: 0.5px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            width: 100%;
            max-width: 280px; /* Max width for buttons */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none; /* For anchor tags styled as buttons */
        }
         .profile-action-button svg {
            width: 18px; height: 18px; fill: currentColor;
         }

        #chat-with-user-button {
            background: var(--accent);
            box-shadow: 0 4px 12px rgba(var(--accent-rgb), 0.3);
            display: none; /* Hidden by default, shown if applicable */
        }
         #chat-with-user-button:hover {
             background: var(--accent-hover);
             box-shadow: 0 8px 20px rgba(var(--accent-rgb), 0.35);
             transform: translateY(-2px) scale(1.03);
         }
         #chat-with-user-button:active { /* Common active style for all profile action buttons */
             transform: translateY(0px) scale(0.97);
         }

        @keyframes slideDownInner {
             from {
                 opacity: 0;
                 transform: translateY(-15px);
             }
             to {
                 opacity: 1;
                 transform: translateY(0);
             }
         }

         @keyframes slideUpInner {
             from {
                 opacity: 0;
                 transform: translateY(15px);
             }
             to {
                 opacity: 1;
                 transform: translateY(0);
             }
         }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-secondary); 
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            z-index: 1000;
            animation: slideUpNav 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(100%);
       }

         @keyframes slideUpNav {
            from {
                opacity: 0;
                transform: translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary); 
           transition: color 0.3s ease, transform 0.2s ease;
            border: none;
            background: none;
            cursor: pointer;
            padding: 5px 10px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            flex: 1;
            text-align: center;
       }

        .nav-item svg {
            width: 24px; 
            height: 24px;
            fill: currentColor;
            margin-bottom: 3px;
            transition: transform 0.2s ease;
       }

        .nav-item:hover {
           color: var(--accent-hover); 
           transform: translateY(-2px);
       }
         .nav-item:hover svg {
             transform: scale(1.1);
         }

        .nav-item.active {
           color: var(--accent); 
           font-weight: bold;
        }
        .nav-item.active svg {
           filter: drop-shadow(0 0 3px var(--accent));
        }

        .nav-item span {
            font-size: 0.75em;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        #page-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 140px); 
            text-align: center;
            color: var(--text-secondary);
        }
        
    </style>
</head>
<body>

    <header class="dashboard-header"> 
      <div class="logo">
          <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4Z" /><path d="M12 6C13.6569 6 15 7.34315 15 9C15 10.6569 13.6569 12 12 12C10.3431 12 9 10.6569 9 9C9 7.34315 10.3431 6 12 6Z" /><path d="M6 12C6 13.6569 7.34315 15 9 15C10.6569 15 12 13.6569 12 12H10C10 12.5523 9.55228 13 9 13C8.44772 13 8 12.5523 8 12H6Z" /><path d="M18 12C18 13.6569 16.6569 15 15 15C13.3431 15 12 13.6569 12 12H14C14 12.5523 14.4477 13 15 13C15.5523 13 16 12.5523 16 12H18Z" /><path d="M12 18C13.6569 18 15 16.6569 15 15H13C13 15.5523 12.5523 16 12 16C11.4477 16 11 15.5523 11 15H9C9 16.6569 10.3431 18 12 18Z" /></svg>
          Sophia Tech
      </div>
    </header>

    <div id="page-loader">
      <p>Loading Profile...</p>
    </div>

    <main class="main-content" style="display: none;">
        <div class="profile-container">
             <div id="message"></div>
            
             <div class="profile-header" style="display: none;">
                 <div class="avatar-container">
                      <img id="avatar-image" src="" alt="User Avatar" style="display: none;">
                      <svg id="avatar-placeholder-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                 </div>
                 <div class="username-line">
                    <span id="profile-username-header">[Username]</span>
                    <span id="verification-badge-container"></span>
                 </div>
                 <span id="profile-header-email"></span>
             </div>
            
            <h2 class="profile-section-title" style="display: none;">Account Information</h2>
            <div class="profile-details" style="display: none;">
                <div class="profile-item">
                    <label>User ID:</label>
                    <span id="profile-id"></span>
                </div>
                <div class="profile-item">
                    <label>Username:</label>
                    <span id="profile-username-detail"></span>
                </div>
                <div class="profile-item">
                    <label>Email:</label>
                    <span id="profile-email-detail"></span>
                </div>
                <div class="profile-item">
                    <label>Role:</label>
                    <span id="profile-role"></span>
                </div>
            </div>

             <div class="profile-actions-container" style="display: none;">
                <a href="#" id="chat-with-user-button" class="profile-action-button" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg>
                    Chat with <span id="chat-button-username">User</span>
                </a>
            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="/dashboard" class="nav-item">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 4h6v6H4zm0 10h6v6H4zm10-10h6v6h-6zm0 10h6v6h-6z"></path></svg>
             <span>Dashboard</span>
        </a>
        <a href="/inbox" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/></svg>
            <span>Inbox</span>
        </a>
        <a href="/profile" class="nav-item"> <!-- No 'active' class initially, JS will set it if it's own profile -->
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
            <span>Profile</span>
        </a>
        <a href="/settings" class="nav-item" id="nav-settings-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19.14 12.94c.04-.32.07-.64.07-.98 0-.34-.03-.66-.07-.98l2.03-1.65a.5.5 0 0 0 .12-.64l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.49-.42h-3.84c-.24 0-.45.17-.49-.42l-.36 2.54c-.59.24-1.13.56-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22l-1.92 3.32c-.12.22-.08.49.12.64l2.03 1.65c-.04.32-.07.65-.07.98 0 .33.03.66.07.98l-2.03 1.65a.5.5 0 0 0-.12.64l1.92 3.32c.12.22.39.28.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.04.24.25.42.49.42h3.84c.24 0 .45-.17.49-.42l.36-2.54c.59-.24 1.13-.56-1.62.94l2.39.96c.2.08.47.02.59-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.01-1.65zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
            <span>Settings</span>
        </a>
    </nav>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const mainContentElement = document.querySelector('.main-content');
    const pageLoaderElement = document.getElementById('page-loader');
    const messageDiv = document.getElementById('message');
    
    if(mainContentElement) mainContentElement.style.display = 'none';
    if(pageLoaderElement) pageLoaderElement.style.display = 'flex';

    const pathParts = window.location.pathname.split('/');
    const targetProfileIdentifier = pathParts[pathParts.length - 1]; // This could be a slug or an ID

    const loggedInUserString = localStorage.getItem('loggedInUser');
    let loggedInUser = null;
    if (loggedInUserString) {
        try {
            loggedInUser = JSON.parse(loggedInUserString);
        } catch (e) {
            console.error("Error parsing loggedInUser from localStorage", e);
        }
    }

    if (!targetProfileIdentifier) {
        showErrorMessage('No user profile specified.');
        if(pageLoaderElement) pageLoaderElement.style.display = 'none';
        if(mainContentElement) mainContentElement.style.display = 'flex'; 
        return;
    }

    // If the targetProfileIdentifier is the same as the logged-in user's ID or SLUG, redirect to their own /profile page
    if (loggedInUser && (loggedInUser.id === targetProfileIdentifier || (loggedInUser.profileSlug && loggedInUser.profileSlug === targetProfileIdentifier))) {
        window.location.href = '/profile';
        return;
    }
    
    // If not logged in and trying to view any profile, redirect to login (optional, or show public profile if allowed)
    if (!loggedInUser) {
        showErrorMessage('Please log in to view profiles. Redirecting...');
        if(pageLoaderElement) pageLoaderElement.style.display = 'none';
        if(mainContentElement) mainContentElement.style.display = 'flex';
        setTimeout(() => { window.location.href = `/login?redirect=${encodeURIComponent(window.location.pathname)}`; }, 2000);
        return;
    }


    fetch(`/auth/verify-user/${targetProfileIdentifier}`)
        .then(response => {
            if (!response.ok) {
                 if (response.status === 404) throw new Error('User profile not found.');
                throw new Error(`Profile fetch failed: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.user) {
                initializeViewProfilePage(data.user, loggedInUser);
                if(mainContentElement) {
                    mainContentElement.style.display = 'flex';
                    mainContentElement.style.animation = 'fadeInScaleUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
                }
            } else {
                showErrorMessage(data.message || 'Could not load profile.');
                if(mainContentElement) mainContentElement.style.display = 'flex';
            }
        })
        .catch(error => {
            console.error('Error fetching user profile:', error);
            showErrorMessage(error.message || 'Error loading profile.');
            if(mainContentElement) mainContentElement.style.display = 'flex';
        })
        .finally(() => {
            if(pageLoaderElement) pageLoaderElement.style.display = 'none';
        });


    function showErrorMessage(text) {
        if (messageDiv) {
            messageDiv.textContent = text;
            messageDiv.className = 'error'; // Ensure class is just 'error' for styling
            messageDiv.style.display = 'block';
        }
        document.querySelector('.profile-header')?.remove();
        document.querySelector('.profile-section-title')?.remove();
        document.querySelector('.profile-details')?.remove();
        document.querySelector('.profile-actions-container')?.remove();
    }
});

function initializeViewProfilePage(targetUser, loggedInUser) {
    const profileHeaderDiv = document.querySelector('.profile-header');
    const profileSectionTitle = document.querySelector('.profile-section-title');
    const profileDetailsDiv = document.querySelector('.profile-details');
    const profileActionsContainer = document.querySelector('.profile-actions-container');
    
    const avatarImage = document.getElementById('avatar-image');
    const avatarPlaceholder = document.getElementById('avatar-placeholder-svg');
    const verificationBadgeContainer = document.getElementById('verification-badge-container');
    const chatWithUserButton = document.getElementById('chat-with-user-button');
    const chatButtonUsernameSpan = document.getElementById('chat-button-username');


    const profileUsernameHeader = document.getElementById('profile-username-header');
    const profileHeaderEmail = document.getElementById('profile-header-email'); 
    const profileIdSpan = document.getElementById('profile-id');
    const profileUsernameDetail = document.getElementById('profile-username-detail');
    const profileEmailDetail = document.getElementById('profile-email-detail'); 
    const profileRoleSpan = document.getElementById('profile-role');

    if (profileUsernameHeader) profileUsernameHeader.textContent = targetUser.username || 'N/A';
    if (profileHeaderEmail) profileHeaderEmail.textContent = targetUser.email || 'N/A'; 
    if (profileIdSpan) profileIdSpan.textContent = targetUser.profileSlug || targetUser.id.substring(0,8)+'...'; // Show slug if available, else truncated ID
    if (profileUsernameDetail) profileUsernameDetail.textContent = targetUser.username || 'N/A';
    if (profileEmailDetail) profileEmailDetail.textContent = targetUser.email || 'N/A'; 
    if (profileRoleSpan) {
      profileRoleSpan.textContent = targetUser.role ? targetUser.role.charAt(0).toUpperCase() + targetUser.role.slice(1) : 'N/A';
    }
    
    if (profileHeaderDiv) profileHeaderDiv.style.display = 'flex';
    if (profileSectionTitle) profileSectionTitle.style.display = 'block';
    if (profileDetailsDiv) profileDetailsDiv.style.display = 'block';
    if (profileActionsContainer) profileActionsContainer.style.display = 'flex';
    
    if (targetUser.avatarUrl && avatarImage) {
        avatarImage.src = targetUser.avatarUrl;
        avatarImage.style.display = 'block';
        if(avatarPlaceholder) avatarPlaceholder.style.display = 'none';
    } else {
        if(avatarImage) avatarImage.style.display = 'none';
        if(avatarPlaceholder) avatarPlaceholder.style.display = 'block';
    }

    if (verificationBadgeContainer) {
        if (targetUser.verified) {
            verificationBadgeContainer.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.9388 1.13669C11.4793 0.449229 12.5208 0.44923 13.0613 1.13669L14.808 3.35829L17.527 2.58767C18.3683 2.34921 19.2109 2.96138 19.2441 3.83525L19.3514 6.65926L22.004 7.63397C22.8249 7.93559 23.1467 8.92611 22.6599 9.6526L21.0868 12.0003L22.6599 14.3481C23.1467 15.0746 22.8249 16.0651 22.004 16.3667L19.3514 17.3414L19.2441 20.1654C19.2109 21.0393 18.3683 21.6515 17.527 21.413L14.808 20.6424L13.0613 22.864C12.5208 23.5515 11.4793 23.5515 10.9388 22.864L9.19206 20.6424L6.47311 21.413C5.63175 21.6515 4.78916 21.0393 4.75596 20.1654L4.64866 17.3414L1.99603 16.3667C1.17519 16.0651 0.853351 15.0746 1.34014 14.3481L2.91324 12.0003L1.34013 9.6526C0.85335 8.92611 1.17519 7.93559 1.99603 7.63397L4.64866 6.65926L4.75596 3.83525C4.78916 2.96138 5.63175 2.34921 6.47311 2.58767L9.19206 3.35829L10.9388 1.13669ZM8.35859 11.8486C8.65148 11.5557 9.12635 11.5557 9.41925 11.8486L10.8889 13.3182L14.3586 9.84858C14.6515 9.55568 15.1264 9.55568 15.4192 9.84858C15.7121 10.1415 15.7121 10.6163 15.4192 10.9092L11.4192 14.9092C11.1264 15.2021 10.6515 15.2021 10.3586 14.9092L8.35859 12.9092C8.06569 12.6163 8.06569 12.1415 8.35859 11.8486Z" clip-rule="evenodd"></path>
                </svg>
            `;
        } else {
            verificationBadgeContainer.innerHTML = ''; 
        }
    }

    if (chatWithUserButton && loggedInUser && loggedInUser.id !== targetUser.id) {
        if(chatButtonUsernameSpan) chatButtonUsernameSpan.textContent = targetUser.username || 'User';
        chatWithUserButton.href = `/chat/${targetUser.id}?receiverUsername=${encodeURIComponent(targetUser.username || 'User')}`;
        chatWithUserButton.style.display = 'flex';
    } else if (chatWithUserButton) {
         chatWithUserButton.style.display = 'none';
    }
    
    document.querySelectorAll('.nav-item.active').forEach(item => item.classList.remove('active'));
    // No specific nav item is active when viewing another's profile, or link to `/profile` (own)
    const profileNav = document.querySelector('a.nav-item[href="/profile"]');
    if(profileNav) profileNav.classList.remove('active');


    if (loggedInUser && loggedInUser.role === 'admin') {
        const settingsNavLink = document.getElementById('nav-settings-link');
        if (settingsNavLink) {
          settingsNavLink.style.display = 'none'; 
        }
    }
}
</script>
</body>
</html>
