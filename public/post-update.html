<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Post | Sophia Tech</title>
  <style>
    :root {
      --primary-bg: #111827; /* Adjusted to match Sophia Tech theme */
      --secondary-bg: #1F2937; /* Adjusted to match Sophia Tech theme */
      --accent-color: #D97706; /* Sophia Tech Accent */
      --text-primary: #E5E7EB; /* Sophia Tech Text Primary */
      --text-secondary: #9CA3AF; /* Sophia Tech Text Secondary */
      --border-color: #374151; /* Sophia Tech Border Primary */
      --success-color: #10B981; /* Sophia Tech Success */
      --error-color: #DC2626; /* Sophia Tech Error */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
      background-color: var(--primary-bg);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
      display: flex; /* Added to center container */
      flex-direction: column; /* Added for centering */
      align-items: center; /* Added for centering */
      padding-top: 70px; /* Space for fixed header if any, or general padding */
      padding-bottom: 70px; /* Space for fixed footer if any */
    }
    
    .dashboard-header { /* Added header style from other Sophia Tech pages */
      width: 100%;
      background-color: var(--secondary-bg);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      border-bottom: 1px solid var(--border-color);
      position: fixed; 
      top: 0;
      left: 0;
      z-index: 1000;
    }

    .dashboard-header .logo {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--accent-color); /* Use accent for logo text */
      display: flex;
      align-items: center;
    }
    .dashboard-header .logo svg {
        width: 30px;
        height: 30px;
        fill: var(--accent-color); /* Use accent for logo svg */
        vertical-align: middle;
        margin-right: 8px;
    }


    .container {
      max-width: 700px; /* Kept from original, can be adjusted */
      width: 100%; /* Ensure it takes available width */
      margin: 20px auto; /* Centering */
      background-color: var(--secondary-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border-color);
    }

    .header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border-color); /* Added border bottom */
      padding-bottom: 15px; /* Added padding bottom */
    }

    .back-btn { /* Adjusted to match Sophia Tech back button style */
      background: none;
      border: none;
      color: var(--accent-color); /* Use accent for back button */
      font-size: 24px;
      margin-right: 15px;
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .back-btn svg { /* Style for SVG inside button */
        width: 24px; 
        height: 24px; 
        stroke-width: 2.5; 
    }

    .back-btn:hover {
      color: var(--accent-hover); /* Accent hover color */
      transform: scale(1.1);
    }

    h1 {
      font-size: 2em; /* Adjusted from other Sophia Pages */
      color: var(--text-primary); /* Adjusted */
    }

    .upload-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 1em; /* Adjusted */
      font-weight: 500;
      color: var(--text-secondary); /* Adjusted */
    }

    textarea { /* Adjusted to match form-control-textarea */
      width: 100%;
      padding: 10px 12px;
      background-color: var(--primary-bg); /* Darker than secondary-bg */
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 1em;
      resize: vertical;
      min-height: 120px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.2); /* Accent color shadow */
    }

    .file-input-container { /* Adjusted to match form-control-file appearance */
      width: 100%;
      padding: 10px 12px;
      background-color: var(--primary-bg); /* Darker */
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 1em;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      cursor: pointer;
      position: relative;
      min-height: 100px; /* Reduced min-height */
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .file-input-container:hover {
      border-color: var(--accent-color);
    }

    .file-input-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .file-input-icon {
      font-size: 30px; /* Adjusted */
      color: var(--accent-color);
    }

    .file-input-text {
      color: var(--text-secondary);
      font-size: 0.9em; /* Adjusted */
    }

    .file-input {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    #filePreviewImage, #filePreviewVideo { /* Combined and styled to match Sophia */
      margin-top: 15px;
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      object-fit: contain;
      display: none; /* Hidden by default */
      background-color: #000; /* Black bg for videos */
    }
    #filePreviewText{ /* Added from Sophia's post-update.html */
        color: var(--text-secondary);
        margin-top: 10px;
        font-size: 0.9em;
        display: none;
    }


    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .action-btn { /* General button style, to be adapted or overridden */
      padding: 12px 24px;
      border-radius: 8px; /* Sophia's border radius */
      font-size: 1.1em; /* Sophia's button font size */
      font-weight: bold; /* Sophia's button font weight */
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      flex: 1;
    }

    .primary-btn { /* To match btn-submit-post */
      background-color: var(--accent-color);
      color: var(--primary-bg); /* Text color for accent bg */
    }

    .primary-btn:hover {
      background-color: #F59E0B; /* Accent hover */
      transform: translateY(-2px);
    }
     .primary-btn:disabled {
        background-color: var(--text-secondary); /* Muted color for disabled */
        cursor: not-allowed;
        transform: none;
    }

    .secondary-btn { /* For cancel button */
      background-color: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .secondary-btn:hover {
      background-color: var(--border-color);
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(17, 24, 39, 0.7); /* Sophia's bg-primary with opacity */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--border-color);
      border-top-color: var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .char-counter {
      align-self: flex-end;
      font-size: 0.85em; /* Adjusted */
      color: var(--text-secondary);
      margin-top: 5px; /* Added margin */
    }

    .char-counter.warning {
      color: var(--error-color);
    }

    .file-size-info {
      font-size: 0.85em; /* Adjusted */
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .file-size-info.warning {
      color: var(--error-color);
    }

     #post-message { /* Added from Sophia's post-update.html */
        text-align: center;
        margin-top: 15px;
        font-weight: bold;
        padding: 8px;
        border-radius: 4px;
        display: none; /* Hidden by default */
     }
     #post-message.success {
        color: var(--success-color);
        background-color: rgba(16, 185, 129, 0.1);
     }
      #post-message.error {
        color: var(--error-color);
        background-color: rgba(220, 38, 38, 0.1);
     }
     #post-message.neutral { /* For pending messages */
        color: var(--text-secondary);
        background-color: rgba(107, 114, 128, 0.1);
     }


    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .bottom-nav { /* Added from Sophia Tech pages */
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: var(--secondary-bg);
        box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3); 
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-around; 
        align-items: center;
        padding: 10px 0;
        z-index: 1000;
    }
    
    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: var(--text-secondary);
        transition: color 0.3s ease, transform 0.2s ease;
        border: none;
        background: none;
        cursor: pointer; 
        padding: 5px 10px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        flex: 1; 
        text-align: center; 
    }
    .nav-item svg { width: 24px; height: 24px; fill: currentColor; margin-bottom: 3px; }
    .nav-item:hover { color: var(--accent-hover); transform: translateY(-2px); }
    .nav-item.active { color: var(--accent-color); font-weight: bold; }
    .nav-item span { font-size: 0.75em; font-weight: bold; }


    @media (max-width: 768px) {
      .container {
        padding: 16px;
        margin-top: 10px; /* Adjust for smaller screens */
      }
      
      .action-buttons {
        flex-direction: column;
      }
      h1 {
        font-size: 1.5em; /* Adjust header for mobile */
      }
    }
  </style>
</head>
<body>
  <header class="dashboard-header">
    <div class="logo">
        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4Z" />
          <path d="M12 6C13.6569 6 15 7.34315 15 9C15 10.6569 13.6569 12 12 12C10.3431 12 9 10.6569 9 9C9 7.34315 10.3431 6 12 6Z" />
          <path d="M6 12C6 13.6569 7.34315 15 9 15C10.6569 15 12 13.6569 12 12H10C10 12.5523 9.55228 13 9 13C8.44772 13 8 12.5523 8 12H6Z" />
          <path d="M18 12C18 13.6569 16.6569 15 15 15C13.3431 15 12 13.6569 12 12H14C14 12.5523 14.4477 13 15 13C15.5523 13 16 12.5523 16 12H18Z" />
          <path d="M12 18C13.6569 18 15 16.6569 15 15H13C13 15.5523 12.5523 16 12 16C11.4477 16 11 15.5523 11 15H9C9 16.6569 10.3431 18 12 18Z" />
        </svg>
        Sophia Tech Admin
    </div>
  </header>

  <div class="container">
    <div class="header">
      <button class="back-btn" onclick="window.location.href='/panel'">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
      </button>
      <h1>Create New Post</h1>
    </div>

    <form class="upload-form" id="post-update-form">
      <div class="form-group">
        <label for="caption">Caption <span id="charCounter">(0/150)</span></label>
        <textarea id="caption" placeholder="Write a caption for your post..." maxlength="150"></textarea>
        <div class="char-counter" id="charCounterDisplay">150 characters remaining</div>
      </div>

      <div class="form-group">
        <label>Media (Image or Video, Max 25MB)</label>
        <div class="file-input-container">
          <input type="file" id="mediaFile" class="file-input" accept="image/*,video/*">
          <label for="mediaFile" class="file-input-label">
            <div class="file-input-icon">üìÅ</div>
            <div class="file-input-text">Click to select an image or video</div>
            <div class="file-size-info" id="fileSizeInfo">Max 25MB</div>
            <img id="filePreviewImage" class="file-preview" alt="Image Preview">
            <video id="filePreviewVideo" class="file-preview" controls></video>
            <p id="filePreviewText" class="file-preview"></p>
          </label>
        </div>
      </div>
        <div id="post-message"></div>
      <div class="action-buttons">
        <button type="submit" class="action-btn primary-btn" id="submit-post-button">Publish Post</button>
        <button type="button" class="action-btn secondary-btn" onclick="window.location.href='/panel'">Cancel</button>
      </div>
    </form>
  </div>

  <div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner"></div>
  </div>
  
  <nav class="bottom-nav">
    <a href="/dashboard" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 4h6v6H4zm0 10h6v6H4zm10-10h6v6h-6zm0 10h6v6h-6z"/>
        </svg>
        <span>Dashboard</span>
    </a>
    <a href="/panel" class="nav-item active" id="admin-panel-link"> 
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12.74 2.32a1 1 0 0 0-1.48 0l-9 9A1 1 0 0 0 3 13h1v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7h1a1 1 0 0 0 .74-1.68l-9-9zM12 4.5l5 5V12h-2v-1a1 1 0 0 0-2 0v1H9V10c0-.47-.14-.93-.4-1.32L5 5.8V5h7zm-1 11v-1h2v1h-2zM5 19v-5h14v5H5z"/>
            <path d="M15.71 14.29a1 1 0 0 0-1.42 1.42L16 17.42V20h-2v-2.58l-1.71-1.71a1 1 0 0 0-1.42 0 1 1 0 0 0 0 1.42L12.58 19H11a1 1 0 0 0-.71.29 1 1 0 0 0-.21.33 1 1 0 0 0 .21 1.07 1 1 0 0 0 .71.29h3a1 1 0 0 0 .71-.29 1 1 0 0 0 .21-1.07 1 1 0 0 0-.21-.33A1 1 0 0 0 13 19h-.58l1.71-1.71a1 1 0 0 0 .03-.02 1 1 0 0 0-.03-1.42z"/>
        </svg>
        <span>Panel</span>
    </a>
    <a href="/inbox" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/></svg>
        <span>Inbox</span>
    </a>
    <a href="/profile" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        <span>Profile</span>
    </a>
  </nav>

  <script>
    const mediaFileInput = document.getElementById('mediaFile');
    const filePreviewImage = document.getElementById('filePreviewImage');
    const filePreviewVideo = document.getElementById('filePreviewVideo');
    const filePreviewText = document.getElementById('filePreviewText');
    const spinnerOverlay = document.getElementById('spinnerOverlay');
    const captionInput = document.getElementById('caption');
    const charCounterDisplay = document.getElementById('charCounterDisplay');
    const fileSizeInfo = document.getElementById('fileSizeInfo');
    const postForm = document.getElementById('post-update-form');
    const submitButton = document.getElementById('submit-post-button');
    const postMessageDiv = document.getElementById('post-message');
    
    const MAX_FILE_SIZE = 25 * 1024 * 1024; // 25MB in bytes
    const MAX_CAPTION_LENGTH = 150; 
    let loggedInUser = null;

    document.addEventListener('DOMContentLoaded', () => {
        const loggedInUserString = localStorage.getItem('loggedInUser');
        if (!loggedInUserString) {
            window.location.href = '/login';
            return;
        }
        try {
            loggedInUser = JSON.parse(loggedInUserString);
            if (!loggedInUser || !loggedInUser.id || loggedInUser.role !== 'admin') {
                window.location.href = '/dashboard'; 
                return;
            }
        } catch (error) {
            window.location.href = '/login';
            return;
        }

        fetch(`/auth/verify-user/${loggedInUser.id}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success || !data.isValid || data.user.role !== 'admin') {
                    window.location.href = '/login'; 
                }
            })
            .catch(() => { window.location.href = '/login'; });
    });


    captionInput.addEventListener('input', function() {
      const remaining = MAX_CAPTION_LENGTH - this.value.length;
      charCounterDisplay.textContent = `${remaining} characters remaining`;
      document.getElementById('charCounter').textContent = `(${this.value.length}/${MAX_CAPTION_LENGTH})`;


      if (remaining < 20) { 
        charCounterDisplay.classList.add('warning');
      } else {
        charCounterDisplay.classList.remove('warning');
      }
    });
    charCounterDisplay.textContent = `${MAX_CAPTION_LENGTH} characters remaining`;
    document.getElementById('charCounter').textContent = `(0/${MAX_CAPTION_LENGTH})`;

    mediaFileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      filePreviewImage.style.display = 'none';
      filePreviewImage.src = '#';
      filePreviewVideo.style.display = 'none';
      filePreviewVideo.src = '';
      filePreviewText.style.display = 'none';
      filePreviewText.textContent = '';
      fileSizeInfo.classList.remove('warning');
      fileSizeInfo.textContent = 'Max 25MB';


      if (!file) return;

      if (file.size > MAX_FILE_SIZE) {
        showPostMessage('File size exceeds 25MB limit.', 'error');
        this.value = ''; 
        fileSizeInfo.classList.add('warning');
        fileSizeInfo.textContent = 'File too large (max 25MB)';
        return;
      } else {
        fileSizeInfo.textContent = `Selected: ${formatFileSize(file.size)} (max 25MB)`;
      }
      showPostMessage('', ''); 

      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          filePreviewImage.src = e.target.result;
          filePreviewImage.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else if (file.type.startsWith('video/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          filePreviewVideo.src = e.target.result;
          filePreviewVideo.style.display = 'block';
          filePreviewVideo.load(); 
        };
        reader.readAsDataURL(file);
      } else {
        filePreviewText.textContent = 'Unsupported file type. Please choose an image or video.';
        filePreviewText.style.display = 'block';
        this.value = '';
      }
    });

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' bytes';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    postForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const mediaFile = mediaFileInput.files[0];
        const caption = captionInput.value.trim();

        if (!mediaFile) {
            showPostMessage('Please select an image or video file.', 'error');
            return;
        }
        if (!caption) {
            showPostMessage('Please enter a caption.', 'error');
            return;
        }
        if (!loggedInUser || !loggedInUser.id) {
            showPostMessage('User not logged in. Please refresh and log in.', 'error');
            return;
        }


        submitButton.disabled = true;
        submitButton.textContent = 'Publishing...';
        spinnerOverlay.style.display = 'flex';
        showPostMessage('Uploading post, please wait...', 'neutral');


        const formData = new FormData();
        formData.append('postImageFile', mediaFile);
        formData.append('caption', caption);
        formData.append('authorId', loggedInUser.id);
        formData.append('authorUsername', loggedInUser.username);

        try {
            const response = await fetch('/api/admin/posts', {
                method: 'POST',
                body: formData,
            });
            const result = await response.json();

            if (response.ok && result.success) {
                showPostMessage('Post published successfully!', 'success');
                postForm.reset(); 
                filePreviewImage.style.display = 'none';
                filePreviewVideo.style.display = 'none';
                filePreviewText.style.display = 'none';
                fileSizeInfo.textContent = 'Max 25MB';
                fileSizeInfo.classList.remove('warning');
                captionInput.dispatchEvent(new Event('input')); 
            } else {
                showPostMessage(result.message || 'Failed to publish post.', 'error');
            }
        } catch (error) {
            console.error('Error publishing post:', error);
            showPostMessage('An error occurred. Please try again.', 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Publish Post';
            spinnerOverlay.style.display = 'none';
        }
    });

    function showPostMessage(message, type) {
        postMessageDiv.textContent = message;
        postMessageDiv.className = ''; 
        if (type) {
            postMessageDiv.classList.add(type);
        }
        postMessageDiv.style.display = message ? 'block' : 'none';
    }

  </script>
</body>
</html>
