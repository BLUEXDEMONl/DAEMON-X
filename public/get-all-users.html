<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Users | Sophia Tech Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563EB; 
      --primary-dark: #1D4ED8; 
      --accent: #D97706; 
      --accent-hover: #F59E0B; 

      --bg-primary: #111827; 
      --bg-secondary: #1F2937; 
      --bg-tertiary: #2d3748; 

      --text-primary: #E5E7EB; 
      --text-secondary: #9CA3AF; 
      --text-muted: #6B7280;
      
      --border-primary: #374151; 
      --border-secondary: #4B5563;

      --success: #10B981; 
      --error: #DC2626; 
      --warning: #F59E0B;

      --primary-rgb: 37, 99, 235; 
      --accent-rgb: 217, 119, 6; 
      --success-rgb: 16, 185, 129;
      --error-rgb: 220, 38, 38;
      --warning-rgb: 245, 158, 11;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      min-height: 100vh;
      color: var(--text-primary);
      background: var(--bg-primary);
      display: flex;
      flex-direction: column; 
      overflow-x: hidden;
      padding-top: 70px; 
      padding-bottom: 70px; 
      line-height: 1.6;
    }

    .dashboard-header {
      width: 100%;
      background-color: var(--bg-secondary);
      padding: 15px 30px;
      display: flex;
      justify-content: flex-start; 
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      border-bottom: 1px solid var(--border-primary);
      position: fixed; 
      top: 0;
      left: 0;
      z-index: 1000;
    }

    .dashboard-header .logo {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary);
      display: flex;
      align-items: center;
    }
    .dashboard-header .logo svg {
        width: 30px;
        height: 30px;
        fill: var(--primary);
        vertical-align: middle;
        margin-right: 8px;
    }
    
    .main-content {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center; 
        padding: 40px 20px;
    }
    
    @keyframes fadeInScaleUp {
         from {
             opacity: 0;
             transform: scale(0.95) translateY(20px);
         }
         to {
             opacity: 1;
             transform: scale(1) translateY(0);
         }
     }

    .content-card-wrapper {
        background-color: var(--bg-secondary);
        padding: 30px 10px 40px 10px; /* Reduced all padding, especially left from 30px to 10px */
        border-radius: 12px;
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4); 
        width: 100%;
        max-width: 1200px; 
        border: 1px solid var(--border-primary);
    }

    .content-card-wrapper h1 {
        font-size: 2em;
        margin-bottom: 25px;
        color: var(--text-primary);
        text-align: center;
        border-bottom: 1px solid var(--border-primary);
        padding-bottom: 15px;
        margin-left: 0; /* Ensures no rightward pull */
    }
    
    #user-list-container {
        margin-top: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
        gap: 20px;
        margin-left: -5px; /* Small negative margin to pull cards left */
        padding-left: 5px; /* Prevents horizontal scroll */
    }

    .user-card {
        background-color: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 8px; 
        padding: 15px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
        display: flex;
        flex-direction: column;
        gap: 12px; 
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .user-card:hover {
        transform: translateY(-4px); 
        box-shadow: 0 6px 16px rgba(var(--primary-rgb), 0.1);
    }

    .user-card-header {
        display: flex;
        align-items: center;
        gap: 12px; 
        border-bottom: 1px solid var(--border-secondary);
        padding-bottom: 12px; 
    }

    .user-card-avatar {
        width: 50px; 
        height: 50px;
        border-radius: 50%;
        background-color: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
        border: 2px solid var(--border-secondary); 
    }
    .user-card-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .user-card-avatar svg { 
        width: 25px; 
        height: 25px;
        fill: var(--text-secondary);
    }

    .user-card-name-role .username-line {
        display: flex;
        align-items: center;
        gap: 6px; 
        font-size: 1.1em; 
        font-weight: bold;
        color: var(--text-primary);
    }
     .user-card-name-role .username-text {
        word-break: break-all;
     }

    .user-card-name-role .verification-badge-panel svg {
        width: 16px; 
        height: 16px;
        fill: var(--success);
    }
    .user-card-name-role .user-card-role {
        font-size: 0.85em; 
        color: var(--text-secondary);
        text-transform: capitalize;
    }

    .user-card-details p {
        font-size: 0.85em; 
        color: var(--text-secondary);
        margin-bottom: 5px; 
        word-break: break-all;
    }
    .user-card-details p strong {
        color: var(--text-primary);
        margin-right: 5px; 
    }
    
    .user-card-actions {
        margin-top: auto; 
        padding-top: 12px; 
        border-top: 1px solid var(--border-secondary);
        display: flex;
        flex-wrap: wrap;
        gap: 8px; 
        justify-content: flex-start; 
    }
    .admin-action-button {
        padding: 6px 10px; 
        text-decoration: none;
        border: none;
        border-radius: 5px; 
        font-size: 0.8em; 
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 4px; 
    }
    .admin-action-button svg {
        width: 12px; 
        height: 12px;
    }

    .btn-view-profile {
        background-color: var(--accent);
        color: var(--bg-primary);
        box-shadow: 0 2px 5px rgba(var(--accent-rgb),0.15);
    }
    .btn-view-profile:hover {
        background-color: var(--accent-hover);
        transform: translateY(-1px);
        box-shadow: 0 3px 7px rgba(var(--accent-rgb),0.25);
    }

    .btn-toggle-verify.verified {
        background-color: var(--warning);
        color: var(--bg-primary);
         box-shadow: 0 2px 5px rgba(var(--warning-rgb),0.15);
    }
    .btn-toggle-verify.verified:hover {
        background-color: #FBBF24; 
        transform: translateY(-1px);
         box-shadow: 0 3px 7px rgba(var(--warning-rgb),0.25);
    }
     .btn-toggle-verify.unverified {
        background-color: var(--success);
        color: var(--bg-primary);
         box-shadow: 0 2px 5px rgba(var(--success-rgb),0.15);
    }
    .btn-toggle-verify.unverified:hover {
        background-color: #34D399; 
        transform: translateY(-1px);
         box-shadow: 0 3px 7px rgba(var(--success-rgb),0.25);
    }
    .btn-delete-user {
        background-color: var(--error);
        color: var(--text-primary);
        box-shadow: 0 2px 5px rgba(var(--error-rgb),0.15);
    }
    .btn-delete-user:hover {
        background-color: #EF4444; 
        transform: translateY(-1px);
        box-shadow: 0 3px 7px rgba(var(--error-rgb),0.25);
    }
    .admin-action-button:disabled {
        background-color: var(--text-muted);
        color: var(--bg-tertiary);
        cursor: not-allowed;
        opacity: 0.6;
        box-shadow: none;
        transform: none;
    }
    
    #users-message {
        text-align: center;
        margin-top: 20px;
        color: var(--text-secondary);
        font-style: italic;
    }

    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: var(--bg-secondary);
        box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3); 
        border-top: 1px solid var(--border-primary);
        display: flex;
        justify-content: space-around; 
        align-items: center;
        padding: 10px 0;
        z-index: 1000;
        animation: slideUpNav 0.5s ease-out forwards;
        opacity: 0;
        transform: translateY(100%);
    }
    
    @keyframes slideUpNav {
        from {
            opacity: 0;
            transform: translateY(100%);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: var(--text-secondary);
        transition: color 0.3s ease, transform 0.2s ease;
        border: none;
        background: none;
        cursor: pointer; 
        padding: 5px 10px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        flex: 1; 
        text-align: center; 
    }

    .nav-item svg {
        width: 24px; 
        height: 24px;
        fill: currentColor; 
        margin-bottom: 3px;
        transition: transform 0.2s ease;
    }

    .nav-item:hover {
        color: var(--accent-hover);
        transform: translateY(-2px);
    }
    .nav-item:hover svg {
        transform: scale(1.1);
    }

    .nav-item.active {
        color: var(--accent);
        font-weight: bold;
    }
    .nav-item.active svg {
        filter: drop-shadow(0 0 3px var(--accent));
    }

    .nav-item span {
        font-size: 0.75em;
        font-weight: bold;
        letter-spacing: 0.5px;
    }
     #page-loader {
        display: flex;
        justify-content: center;
        align-items: center;
        height: calc(100vh - 140px);
        text-align: center;
        color: var(--text-secondary);
    }
  </style>
</head>
<body>

  <header class="dashboard-header">
    <div class="logo">
        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4Z" />
          <path d="M12 6C13.6569 6 15 7.34315 15 9C15 10.6569 13.6569 12 12 12C10.3431 12 9 10.6569 9 9C9 7.34315 10.3431 6 12 6Z" />
          <path d="M6 12C6 13.6569 7.34315 15 9 15C10.6569 15 12 13.6569 12 12H10C10 12.5523 9.55228 13 9 13C8.44772 13 8 12.5523 8 12H6Z" />
          <path d="M18 12C18 13.6569 16.6569 15 15 15C13.3431 15 12 13.6569 12 12H14C14 12.5523 14.4477 13 15 13C15.5523 13 16 12.5523 16 12H18Z" />
          <path d="M12 18C13.6569 18 15 16.6569 15 15H13C13 15.5523 12.5523 16 12 16C11.4477 16 11 15.5523 11 15H9C9 16.6569 10.3431 18 12 18Z" />
        </svg>
        Sophia Tech Admin
    </div>
  </header>

  <div id="page-loader">
    <p>Loading Users...</p>
  </div>

  <main class="main-content" style="display: none;">
    <div class="content-card-wrapper">
        <h1>All Registered Users</h1>
        <div id="users-message"></div>
        <div id="user-list-container">
        </div>
    </div>
  </main>

  <nav class="bottom-nav">
    <a href="/dashboard" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 4h6v6H4zm0 10h6v6H4zm10-10h6v6h-6zm0 10h6v6h-6z"/>
        </svg>
        <span>Dashboard</span>
    </a>
    <a href="/panel" class="nav-item active" id="admin-panel-link"> 
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12.74 2.32a1 1 0 0 0-1.48 0l-9 9A1 1 0 0 0 3 13h1v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7h1a1 1 0 0 0 .74-1.68l-9-9zM12 4.5l5 5V12h-2v-1a1 1 0 0 0-2 0v1H9V10c0-.47-.14-.93-.4-1.32L5 5.8V5h7zm-1 11v-1h2v1h-2zM5 19v-5h14v5H5z"/>
            <path d="M15.71 14.29a1 1 0 0 0-1.42 1.42L16 17.42V20h-2v-2.58l-1.71-1.71a1 1 0 0 0-1.42 0 1 1 0 0 0 0 1.42L12.58 19H11a1 1 0 0 0-.71.29 1 1 0 0 0-.21.33 1 1 0 0 0 .21 1.07 1 1 0 0 0 .71.29h3a1 1 0 0 0 .71-.29 1 1 0 0 0 .21-1.07 1 1 0 0 0-.21-.33A1 1 0 0 0 13 19h-.58l1.71-1.71a1 1 0 0 0 .03-.02 1 1 0 0 0-.03-1.42z"/>
        </svg>
        <span>Panel</span>
    </a>
    <a href="/inbox" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/></svg>
        <span>Inbox</span>
    </a>
    <a href="/profile" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        <span>Profile</span>
    </a>
  </nav>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const mainContentElement = document.querySelector('.main-content');
        const pageLoaderElement = document.getElementById('page-loader');
        const userListContainer = document.getElementById('user-list-container');
        const usersMessageDiv = document.getElementById('users-message');
        let loggedInUser = null;

        if (mainContentElement) mainContentElement.style.display = 'none';
        if (pageLoaderElement) pageLoaderElement.style.display = 'flex';

        const loggedInUserString = localStorage.getItem('loggedInUser');

        if (!loggedInUserString) {
            window.location.href = '/login';
            return;
        }

        try {
            loggedInUser = JSON.parse(loggedInUserString);
            if (!loggedInUser || !loggedInUser.id) {
                throw new Error("Invalid user data in localStorage");
            }
        } catch (error) {
            console.error('Error parsing user data from localStorage:', error);
            localStorage.removeItem('loggedInUser');
            window.location.href = '/login';
            return;
        }
        
        if (loggedInUser.role !== 'admin') {
            usersMessageDiv.textContent = "Access Denied: This page is for admins only.";
            usersMessageDiv.style.color = 'var(--error)';
            if (pageLoaderElement) pageLoaderElement.style.display = 'none';
            if (mainContentElement) mainContentElement.style.display = 'flex'; 
            return;
        }

        fetch(`/auth/verify-user/${loggedInUser.id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`User verification failed: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.isValid && data.user.role === 'admin') {
                    loadAllUsers(); 
                    if (mainContentElement) {
                         mainContentElement.style.display = 'flex';
                         mainContentElement.style.animation = 'fadeInScaleUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
                    }
                } else {
                    localStorage.removeItem('loggedInUser');
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Error during user verification for Get All Users page:', error);
                localStorage.removeItem('loggedInUser');
                window.location.href = '/login';
            })
            .finally(() => {
                 if (pageLoaderElement) pageLoaderElement.style.display = 'none';
            });

        function showUsersMessage(message, type = 'info') {
            usersMessageDiv.textContent = message;
            usersMessageDiv.style.color = type === 'error' ? 'var(--error)' : (type === 'success' ? 'var(--success)' : 'var(--text-secondary)');
        }
        
        async function handleToggleVerify(userId, currentVerifiedStatus) {
            const newVerifiedStatus = !currentVerifiedStatus;
            showUsersMessage('Updating verification status...', 'info');
            try {
                const response = await fetch(`/api/admin/users/${userId}/update`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ verified: newVerifiedStatus })
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    showUsersMessage(`User ${newVerifiedStatus ? 'verified' : 'unverified'} successfully.`, 'success');
                    loadAllUsers(); 
                } else {
                    throw new Error(result.message || 'Failed to update verification status.');
                }
            } catch (error) {
                console.error('Error toggling verification:', error);
                showUsersMessage(`Error: ${error.message}`, 'error');
            }
        }

        async function handleDeleteUser(userId, username) {
            if (!confirm(`Are you sure you want to delete the user "${username}"? This action cannot be undone.`)) {
                return;
            }
            showUsersMessage('Deleting user...', 'info');
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    showUsersMessage(`User "${username}" deleted successfully.`, 'success');
                    loadAllUsers(); 
                } else {
                    throw new Error(result.message || 'Failed to delete user.');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showUsersMessage(`Error: ${error.message}`, 'error');
            }
        }


        function createUserCardElement(user) {
            const card = document.createElement('div');
            card.className = 'user-card';
            card.id = `user-card-${user.id}`;

            const avatarSrc = user.avatarUrl ? user.avatarUrl : '';
            const avatarImg = avatarSrc 
                ? `<img src="${avatarSrc}" alt="${user.username}'s avatar">`
                : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>`;
            
            let verificationBadgeHtml = '';
            if (user.verified) {
                verificationBadgeHtml = `
                    <span class="verification-badge-panel" title="Verified User">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M10.9388 1.13669C11.4793 0.449229 12.5208 0.44923 13.0613 1.13669L14.808 3.35829L17.527 2.58767C18.3683 2.34921 19.2109 2.96138 19.2441 3.83525L19.3514 6.65926L22.004 7.63397C22.8249 7.93559 23.1467 8.92611 22.6599 9.6526L21.0868 12.0003L22.6599 14.3481C23.1467 15.0746 22.8249 16.0651 22.004 16.3667L19.3514 17.3414L19.2441 20.1654C19.2109 21.0393 18.3683 21.6515 17.527 21.413L14.808 20.6424L13.0613 22.864C12.5208 23.5515 11.4793 23.5515 10.9388 22.864L9.19206 20.6424L6.47311 21.413C5.63175 21.6515 4.78916 21.0393 4.75596 20.1654L4.64866 17.3414L1.99603 16.3667C1.17519 16.0651 0.853351 15.0746 1.34014 14.3481L2.91324 12.0003L1.34013 9.6526C0.85335 8.92611 1.17519 7.93559 1.99603 7.63397L4.64866 6.65926L4.75596 3.83525C4.78916 2.96138 5.63175 2.34921 6.47311 2.58767L9.19206 3.35829L10.9388 1.13669ZM8.35859 11.8486C8.65148 11.5557 9.12635 11.5557 9.41925 11.8486L10.8889 13.3182L14.3586 9.84858C14.6515 9.55568 15.1264 9.55568 15.4192 9.84858C15.7121 10.1415 15.7121 10.6163 15.4192 10.9092L11.4192 14.9092C11.1264 15.2021 10.6515 15.2021 10.3586 14.9092L8.35859 12.9092C8.06569 12.6163 8.06569 12.1415 8.35859 11.8486Z" clip-rule="evenodd"></path>
                        </svg>
                    </span>`;
            }
            
            const actionsHtml = `
                <a href="/profile/${user.profileSlug || user.id}" class="admin-action-button btn-view-profile" target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
                    View
                </a>
                <button class="admin-action-button btn-toggle-verify ${user.verified ? 'verified' : 'unverified'}" 
                        data-user-id="${user.id}" data-verified="${user.verified}" 
                        ${user.username === 'admin' || user.id === loggedInUser.id ? 'disabled' : ''}>
                    ${user.verified ? 
                        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1.41-4.41L15 11.17V6h-2v4.17l-2.59-2.58L9 9.17l4.41 4.42zM12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z M16,11H8v2h8V11z"></path></svg>Unverify' : 
                        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path></svg>Verify'}
                </button>
                <button class="admin-action-button btn-delete-user" data-user-id="${user.id}" data-username="${user.username}" 
                        ${user.username === 'admin' || user.id === loggedInUser.id ? 'disabled' : ''}>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                    Delete
                </button>
            `;


            card.innerHTML = `
                <div class="user-card-header">
                    <div class="user-card-avatar">${avatarImg}</div>
                    <div class="user-card-name-role">
                        <h3 class="username-line">
                            <span class="username-text">${user.username}</span>
                            ${verificationBadgeHtml}
                        </h3>
                        <p class="user-card-role">Role: ${user.role}</p>
                    </div>
                </div>
                <div class="user-card-details">
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>User ID:</strong> ${user.id.substring(0,12)}...</p>
                    <p><strong>Profile Slug:</strong> ${user.profileSlug || 'N/A'}</p>
                </div>
                <div class="user-card-actions">
                    ${actionsHtml}
                </div>
            `;

            card.querySelector('.btn-toggle-verify').addEventListener('click', (e) => {
                const targetButton = e.currentTarget;
                handleToggleVerify(targetButton.dataset.userId, targetButton.dataset.verified === 'true');
            });
            card.querySelector('.btn-delete-user').addEventListener('click', (e) => {
                const targetButton = e.currentTarget;
                handleDeleteUser(targetButton.dataset.userId, targetButton.dataset.username);
            });

            return card;
        }

        async function loadAllUsers() {
            showUsersMessage('Fetching users...', 'info');
            userListContainer.innerHTML = ''; 
            try {
                const response = await fetch('/api/admin/users');
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Failed to fetch users: ${response.status}`);
                }
                const users = await response.json();

                if (users && users.length > 0) {
                    users.forEach(user => {
                        const userCardElement = createUserCardElement(user);
                        userListContainer.appendChild(userCardElement);
                    });
                    showUsersMessage(`${users.length} user(s) loaded.`, 'info');
                } else {
                    showUsersMessage('No users found in the database.', 'info');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showUsersMessage(`Error: ${error.message}`, 'error');
            }
        }
    });
  </script>
</body>
</html>

    